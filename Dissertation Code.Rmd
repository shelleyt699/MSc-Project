---
title: "Dissertation Draft"
author: "Shelley Tang"
date: '2022-08-13'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
```

# Libraries

```{r}
library(readxl)
library(tidyverse)
library(lubridate)
library(zoo)
library(forecast)
library(imputeTS)
library(TSA)
library(tseries)
library(xts)
library(astsa)
library(padr)
library(Metrics)
library(DescTools)
library(lmtest)
library(gridExtra)
library(ggpubr)
library(dLagM)
library(GGally)
setwd("~/Documents/MSc_Data_Science_and_Statistics_Coursework/Dissertation/Updated data and R code")

```

# Data Preprocessing and Exploratory Data Analysis


```{r}
#Step one: explore reported new cases data near sewage plant with possibility 
#to create a model that represents the whole population? 
#use NC reported cases data?....
reported_cases <- read_excel("New_Cases_Per_10K_updated_in_wwtp.xlsx")
glimpse(reported_cases)
colnames(reported_cases)[2] <- "wwtp"
colnames(reported_cases)[5] <- "population"
colnames(reported_cases)[6] <- "new_cases_per_10k"
glimpse(reported_cases)
reported_cases <- reported_cases %>% arrange(mdy(reported_cases$Date))
reported_cases$Date <- mdy(reported_cases$Date)
table(reported_cases$County)

png(filename="new_cases_plot.png", res = 500,units = "cm", width = 20, height = 10)
na.omit(reported_cases) %>% ggplot(aes(Date,new_cases_per_10k)) + facet_wrap(~County) + geom_line() + 
  ylab("New COVID-19 cases per 10K") + theme_bw()
dev.off()

png(filename="log_new_cases_boxplot.png", res = 500,units = "cm", width = 20, height = 12)
na.omit(reported_cases) %>% ggplot(aes(County,log(new_cases_per_10k))) + 
  geom_boxplot() + ylab("Logarithm of new COVID-19 cases per 10k") +
  theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
dev.off()

#Wake: New Cases
wake_reported_cases <- subset(reported_cases,County=="Wake")
glimpse(wake_reported_cases)
summary(wake_reported_cases)
which(is.na(wake_reported_cases$`New Cases Per 10,000 Persons`))
wake_reported_cases %>% slice_min(new_cases_per_10k)
wake_reported_cases %>% slice_max(new_cases_per_10k)

wake_reported_cases$new_cases_per_10k <- LOCF(wake_reported_cases$new_cases_per_10k)
summary(wake_reported_cases)

df_wake <- wake_reported_cases %>% group_by(Date) %>% summarise(mean_new_cases=mean(new_cases_per_10k))
summary(df_wake)

#Wake: wastewater viral gene copies

wastewater_data <- read_excel("wastewater_data_updated.xlsx")
glimpse(wastewater_data)
wastewater_data <- wastewater_data%>% arrange(mdy(wastewater_data$Date))
wastewater_data$Date <- mdy(wastewater_data$Date)
colnames(wastewater_data)[2]<-"wwtp"
colnames(wastewater_data)[5]<-"population"
colnames(wastewater_data)[6]<-"viral_gene_copies_per_person"
colnames(wastewater_data)[7]<-"viral_gene_copies/L"

summary(wastewater_data) #no missing values

png(filename="viral_gene_plot.png", res = 500,units = "cm", width = 20, height = 10)
wastewater_data %>% ggplot(aes(Date,viral_gene_copies_per_person)) + geom_line() + 
  facet_wrap(~ County) + theme_bw() + ylab("Viral gene copies per person")
dev.off()

png(filename="log_viral_gene_boxplot.png", res = 500,units = "cm", width = 20, height = 10)
wastewater_data %>% ggplot(aes(County,log(viral_gene_copies_per_person))) + geom_boxplot() +
  theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
    ylab("log(Viral gene copies per person)")
dev.off()

wake_wastewater_data <- wastewater_data %>% dplyr::filter(County=='Wake')
summary(wake_wastewater_data)
wake_wastewater_data %>% slice_min(viral_gene_copies_per_person)
wake_wastewater_data %>% slice_max(viral_gene_copies_per_person)

png(filename="viral_gene_plot_wake.png", res = 500,units = "cm", width = 20, height = 10)
wake_wastewater_data %>% ggplot(aes(Date,viral_gene_copies_per_person)) + geom_line() + 
  facet_wrap(~ wwtp) + theme_bw(base_size = 16) + ylab("Viral gene copies per person")
dev.off()

png(filename="log_viral_gene_plot_wake.png", res = 500,units = "cm", width = 20, height = 10)
wake_wastewater_data %>% ggplot(aes(wwtp,log(viral_gene_copies_per_person))) + 
  geom_boxplot() + theme_bw(base_size = 16) + 
  ylab("Log(viral gene copies per person)") + 
  xlab("Wastewater treatment plants")
dev.off()

average_wake_wastewater <- wake_wastewater_data %>% group_by(Date) %>% 
  summarise(mean_viral_gene_copies_per_person = mean(viral_gene_copies_per_person))

average_wake_wastewater
full_average_wake_wastewater <- pad(average_wake_wastewater,start_val = as.Date('2021-01-04'),
                                    end_val = as.Date('2022-05-25'))
full_average_wake_wastewater <- full_average_wake_wastewater %>% 
  mutate(full_viral_gene_copies_per_person = na_locf(mean_viral_gene_copies_per_person))
full_average_wake_wastewater %>% ggplot(aes(Date,full_viral_gene_copies_per_person)) + geom_line()
full_average_wake_wastewater <- full_average_wake_wastewater %>% select(Date,full_viral_gene_copies_per_person)
summary(full_average_wake_wastewater)

#Wake: merged data

full_cases_wastewater_data <- merge(df_wake[-1,],full_average_wake_wastewater,by="Date")
summary(full_cases_wastewater_data )

which.min(full_cases_wastewater_data$mean_new_cases)
full_cases_wastewater_data[183,]
which.min(full_cases_wastewater_data$full_viral_gene_copies_per_person)
full_cases_wastewater_data[125,] #minimum covid-19 prevalence within same season 

which.max(full_cases_wastewater_data$mean_new_cases)
full_cases_wastewater_data[367,]
which.max(full_cases_wastewater_data$full_viral_gene_copies_per_person)
full_cases_wastewater_data[376,] #maximum covid-19 prevalence within same month

#Mecklenburg: covid_cases

mecklenburg_reported_cases <- subset(reported_cases,County=="Mecklenburg")
glimpse(mecklenburg_reported_cases)
summary(mecklenburg_reported_cases)
mecklenburg_reported_cases$new_cases_per_10k <- LOCF(mecklenburg_reported_cases$new_cases_per_10k)
df_mecklenburg <- mecklenburg_reported_cases %>% group_by(Date) %>% summarise(mean_new_cases = 
                                                                                mean(new_cases_per_10k))
summary(df_mecklenburg[-1,])

#Mecklenburg: wastewater viral gene copies

mecklenburg_wastewater_data <- wastewater_data %>% dplyr::filter(County=='Mecklenburg')
summary(mecklenburg_wastewater_data)

png(filename="viral_gene_plot_meck.png", res = 500,units = "cm", width = 20, height = 10)
mecklenburg_wastewater_data%>% ggplot(aes(Date,viral_gene_copies_per_person)) + geom_line() + 
  facet_wrap(~ wwtp) + theme_bw(base_size = 16) + ylab("Viral gene copies per person")
dev.off()

png(filename="log_viral_gene_plot_meck.png", res = 500,units = "cm", width = 20, height = 10)
mecklenburg_wastewater_data %>% ggplot(aes(wwtp,log(viral_gene_copies_per_person))) +
  geom_boxplot()+ theme_bw(base_size = 16) + 
  ylab("Log(viral gene copies per person)") +xlab("Wastewater treatment plants")
dev.off()

average_meck_wastewater <- mecklenburg_wastewater_data %>% group_by(Date) %>% 
  summarise(mean_viral_gene_copies_per_person = mean(viral_gene_copies_per_person))

average_meck_wastewater
full_average_meck_wastewater <- pad(average_meck_wastewater,start_val = as.Date('2021-01-04'),
                                    end_val = as.Date('2022-05-25'))
full_average_meck_wastewater <- full_average_meck_wastewater %>% 
  mutate(full_viral_gene_copies_per_person = na_locf(mean_viral_gene_copies_per_person))

full_average_meck_wastewater%>% ggplot(aes(Date,full_viral_gene_copies_per_person)) + 
  geom_line()

full_average_wake_wastewater <- full_average_meck_wastewater %>% select(Date,full_viral_gene_copies_per_person)
summary(full_average_meck_wastewater)

#Mecklenburg: merged data

full_cases_wastewater_data_meck <- merge(df_mecklenburg,full_average_meck_wastewater,by="Date")
summary(full_cases_wastewater_data_meck)

which.min(full_cases_wastewater_data_meck$mean_new_cases)
full_cases_wastewater_data_meck[155,]
which.min(full_cases_wastewater_data_meck$full_viral_gene_copies_per_person)
full_cases_wastewater_data_meck[66,] #minimum covid-19 prevalence not in the same period.....

which.max(full_cases_wastewater_data_meck$mean_new_cases)
full_cases_wastewater_data_meck[368,]
which.max(full_cases_wastewater_data_meck$full_viral_gene_copies_per_person)
full_cases_wastewater_data_meck[369,] #maximum covid-19 prevalence within same month, reflecting the peak

#New Hanover: covid cases

new_hanover_reported_cases <- subset(reported_cases,County=="New Hanover")
glimpse(new_hanover_reported_cases)
summary(new_hanover_reported_cases)

new_hanover_reported_cases$new_cases_per_10k <- LOCF(new_hanover_reported_cases$new_cases_per_10k)
summary(new_hanover_reported_cases)

df_new_hanover <- new_hanover_reported_cases %>% group_by(Date) %>% 
  summarise(mean_new_cases = mean(new_cases_per_10k))
summary(df_new_hanover[-1,])

#New Hanover: wastewater viral gene copies per person 

new_hanover_wastewater_data <- wastewater_data %>% dplyr::filter(County=='New Hanover')

png(filename="viral_gene_plot_hanover.png", res = 500,units = "cm", width = 20, height = 10)
new_hanover_wastewater_data%>% ggplot(aes(Date,viral_gene_copies_per_person)) + geom_line() + 
  facet_wrap(~ wwtp) + theme_bw(base_size = 16) + ylab("Viral gene copies per person")
dev.off()

png(filename="log_viral_gene_plot_hanover.png", res = 500,units = "cm", width = 20, height = 10)
new_hanover_wastewater_data %>% ggplot(aes(wwtp,log(viral_gene_copies_per_person))) +
  geom_boxplot() + theme_bw(base_size = 16) + xlab("Log(viral gene copies per person)")
dev.off()

average_hanover_wastewater <- new_hanover_wastewater_data %>% group_by(Date) %>% 
  summarise(mean_viral_gene_copies_per_person = mean(viral_gene_copies_per_person))

full_average_hanover_wastewater <- pad(average_hanover_wastewater,start_val = as.Date('2021-01-04'),
                                       end_val = as.Date('2022-05-25'))
full_average_hanover_wastewater <- full_average_hanover_wastewater %>% 
  mutate(full_viral_gene_copies_per_person = na_locf(mean_viral_gene_copies_per_person))
average_hanover_wastewater %>% ggplot(aes(Date,mean_viral_gene_copies_per_person)) + geom_line()
full_average_hanover_wastewater <- full_average_hanover_wastewater %>% select(Date,full_viral_gene_copies_per_person)
summary(full_average_hanover_wastewater)

#New Hanover: Merged Data

full_cases_wastewater_data_hanover <- merge(df_new_hanover[-1,],full_average_hanover_wastewater,by="Date")
summary(full_cases_wastewater_data_hanover)

which.min(full_cases_wastewater_data_hanover$mean_new_cases)
full_cases_wastewater_data_meck[141,]
which.min(full_cases_wastewater_data_hanover$full_viral_gene_copies_per_person)
full_cases_wastewater_data_meck[124,] #minimum covid-19 prevalence in the same period.....

which.max(full_cases_wastewater_data_hanover$mean_new_cases)
full_cases_wastewater_data_meck[382,]
which.max(full_cases_wastewater_data_hanover$full_viral_gene_copies_per_person)
full_cases_wastewater_data_meck[384,] #maximum covid-19 prevalence within same month, reflecting the peak

#plot of wake, meck and new hanover#

png(filename = "cases_analysis.png", units = "cm", res = 700,
    width = 20, height = 10)
full_cases_wastewater_data %>% ggplot(aes(Date,mean_new_cases)) + 
  geom_line(aes(color="Wake")) +
  geom_line(data = full_cases_wastewater_data_meck,
            aes(Date,mean_new_cases, color="Mecklenburg")) +
  geom_line(data = full_cases_wastewater_data_hanover,
            aes(Date,mean_new_cases, color="New Hanover")) +
  scale_colour_manual(values=c("Wake"="mediumseagreen", "Mecklenburg"="mediumpurple1", 
                               "New Hanover"="maroon1"), 
                      labels=c("Wake", "Mecklenburg", "New Hanover")) + theme_bw() +
  ylab("New COVID-19 cases") + theme(legend.position = "bottom")
dev.off()

png(filename = "wastewater_analysis.png", units = "cm", res = 700,
    width = 20, height = 10)
full_cases_wastewater_data %>% ggplot(aes(Date,full_viral_gene_copies_per_person)) + 
  geom_line(aes(color="Wake")) +
  geom_line(data = full_cases_wastewater_data_meck,
            aes(Date,full_viral_gene_copies_per_person, color="Mecklenburg")) +
  geom_line(data = full_cases_wastewater_data_hanover,
            aes(Date,full_viral_gene_copies_per_person, color="New Hanover")) +
  scale_colour_manual(values=c("Wake"="mediumseagreen", "Mecklenburg"="mediumpurple1", 
                               "New Hanover"="maroon1"), 
                      labels=c("Wake", "Mecklenburg", "New Hanover")) + theme_bw() +
  ylab("Viral gene copies per person") + theme(legend.position = "bottom")
dev.off()


#Weather properties that affect wastewater#

#Wake weather: data preprocessing#
wake_weather <- read.csv("wake_weather.csv")
glimpse(wake_weather)
sum(is.na(wake_weather$PRCP)) #757 NA, assume no rain...
#which(is.na(wake_weather$PRCP))
wake_weather <- 
  wake_weather %>% mutate(PRCP = replace_na(PRCP,mean(PRCP,na.rm=TRUE)))

wake_weather_prcp <- wake_weather %>% group_by(DATE) %>% summarise(mean_precipation = mean(PRCP))

sum(is.na(wake_weather$TAVG))
sum(is.na(wake_weather$TMIN))
sum(is.na(wake_weather$TMAX))
sum(is.na(wake_weather$TOBS))

#temperature is the same in all towns within Wake
full_tavg_data <- wake_weather[complete.cases(wake_weather$TAVG),]  
table(full_tavg_data$STATION) #only one stations 
wake_temp <- full_tavg_data %>% select(DATE,TAVG)

wake_weather <- merge(wake_weather_prcp,wake_temp,order.by=DATE)
summary(wake_weather)
wake_weather$DATE <- as.Date(wake_weather$DATE)
summary(wake_weather)
colnames(wake_weather)[1]<-"Date"

#mecklenburg weather: data preprocessing#

meck_weather <- read.csv("mecklenburg_weather.csv")
glimpse(meck_weather)
sum(is.na(meck_weather$PRCP))
meck_weather <- 
  meck_weather %>% mutate(PRCP = replace_na(PRCP,mean(PRCP,na.rm=TRUE)))
          
meck_weather_prcp <- meck_weather %>% group_by(DATE) %>% summarise(mean_precipation = mean(PRCP))
meck_weather_prcp

sum(is.na(meck_weather$TAVG))
full_tavg_data_meck <- meck_weather[complete.cases(meck_weather$TAVG),]
table(full_tavg_data_meck$STATION)
meck_temp <- full_tavg_data_meck %>% select(DATE,TAVG)

meck_weather <- merge(meck_weather_prcp,meck_temp, order.by=DATE)
meck_weather$DATE <- as.Date(meck_weather$DATE)
summary(meck_weather)
colnames(meck_weather)[1]<-"Date"
summary(meck_weather)

#new hanover weather: data preprocessing#

hanover_weather<- read.csv("new_hanover_weather.csv")
glimpse(hanover_weather)
sum(is.na(hanover_weather$PRCP))
hanover_weather <- 
  hanover_weather%>% mutate(PRCP = replace_na(PRCP,mean(PRCP,na.rm=TRUE)))

hanover_weather_prcp <- hanover_weather %>% group_by(DATE) %>% summarise(mean_precipation = mean(PRCP))
hanover_weather_prcp

sum(is.na(hanover_weather$TAVG)) #no data
sum(is.na(hanover_weather$TMIN))
#which(is.na(hanover_weather$TMIN))
sum(is.na(hanover_weather$TMAX))
#which(is.na(hanover_weather$TMAX))

full_temp_data_new_hanover <- 
  hanover_weather[complete.cases(hanover_weather$TMIN),]
full_temp_data_new_hanover 
full_temp_data_new_hanover[238,]
full_temp_data_new_hanover[237,]
full_temp_data_new_hanover[239,]
full_temp_data_new_hanover <- full_temp_data_new_hanover %>%
  rowwise() %>% 
  mutate(TMED = median(c(TMIN:TMAX)))

table(full_temp_data_new_hanover$STATION)

hanover_temp <- full_temp_data_new_hanover %>% group_by(DATE) %>% summarise(mean_temp = mean(TMED))

hanover_weather <- merge(hanover_weather_prcp,hanover_temp, order.by=DATE)
hanover_weather$DATE <- as.Date(hanover_weather$DATE)
summary(hanover_weather)
colnames(hanover_weather)[1]<-"Date"
summary(hanover_weather)

#precipation and temp plots#

wake_prep_plot <- wake_weather %>% ggplot(aes(Date,mean_precipation)) + 
  geom_line() + xlab("") + ylab("") + theme_bw(base_size = 14)

meck_prep_plot <- meck_weather %>% ggplot(aes(Date,mean_precipation)) + 
  geom_line() + xlab("") + ylab("") + theme_bw(base_size = 14)

hanover_prep_plot <- hanover_weather %>% ggplot(aes(Date,mean_precipation)) + 
  geom_line() + ylab("") + theme_bw(base_size = 14)

png(filename="precipitation.png", res = 500,units = "cm", width = 20, height = 10)
grid.arrange(wake_prep_plot,meck_prep_plot,hanover_prep_plot,
             left = text_grob("Mean Precipitaion (in inches)", rot = 90, vjust = 1))
dev.off()

wake_temp_plot <- wake_weather %>% ggplot(aes(Date,TAVG)) + 
  geom_line() + xlab("") + ylab("") + theme_bw(base_size = 14)

meck_temp_plot <- meck_weather %>% ggplot(aes(Date,TAVG)) + 
  geom_line() + xlab("") + ylab("") + theme_bw(base_size = 14)

hanover_temp_plot <- hanover_weather %>% ggplot(aes(Date,mean_temp)) + 
  geom_line() + ylab("") + theme_bw(base_size = 14)

png(filename="temp.png", res = 500,units = "cm", width = 20, height = 10)
grid.arrange(wake_temp_plot,meck_temp_plot,hanover_temp_plot,
             left = text_grob("Average Temperature (in °F)", rot = 90, vjust = 1))
dev.off()

#merge datasets

full_cases_wastewater_weather_data <- merge(full_cases_wastewater_data,
                                            wake_weather, order.by=Date)
full_cases_wastewater_weather_data_meck <- merge(full_cases_wastewater_data_meck,
                                            meck_weather, order.by=Date)
full_cases_wastewater_weather_data_hanover <- merge(full_cases_wastewater_data_hanover,
                                                 hanover_weather, order.by=Date)

#Correlations

png(filename="wake_correlations.png", 
    res = 700,units = "cm", width = 20, height = 10)
ggpairs(full_cases_wastewater_weather_data, 
        columns = 2:5,
        columnLabels = c("New Cases","Viral Gene",
                         "Precipitation", "Temperature")) +
  theme_bw()
dev.off()

png(filename="meck_correlations.png", 
    res = 700,units = "cm", width = 20, height = 10)
ggpairs(full_cases_wastewater_weather_data_meck, 
        columns = c(2,4:6),
        columnLabels = c("New Cases","Viral Gene",
                         "Precipitation", "Temperature")) +
  theme_bw()
dev.off()

png(filename="hanover_correlations.png", 
    res = 700,units = "cm", width = 20, height = 10)
ggpairs(full_cases_wastewater_weather_data_hanover, 
        columns = c(2:5),
        columnLabels = c("New Cases","Viral Gene",
                         "Precipitation", "Temperature")) +
  theme_bw()
dev.off()
```

# Modelling COVID-19 cases only

## ARIMA modelling

```{r}
### Wake
df_wake_1 <- xts(df_wake$mean_new_cases,order.by = df_wake$Date)
df_wake_1 <- df_wake_1[-c(1,506,507,508),] #making even weekly data
attr(df_wake_1, 'frequency') <- 7 
periodicity(df_wake_1)  
df_wake_1_ts <- as.ts(df_wake_1)
plot(decompose(log(df_wake_1_ts))) #exponential growth is evident at the peakk
df_wake_seasonal_decomp <- decompose(log(df_wake_1_ts))

png(filename = "Additive_season.png",res = 700, units = "cm",width = 20, height = 14)
plot(df_wake_seasonal_decomp)
dev.off()

df_wake_deseasonal_decomp <- seasadj(df_wake_seasonal_decomp)

png(filename = "season_adjust.png",res = 700, units = "cm",width = 20, height = 12)
tsdisplay(df_wake_deseasonal_decomp, main = NULL)
dev.off()

#Forecasting

train_df_seasonal <- ts(log(df_wake_1_ts)[-c(491:504)], frequency=7)
test_df_seasonal <- log(df_wake_1_ts)[c(491:504)]

train_df1 <- df_wake_deseasonal_decomp[-c(491:504)]
test_df1 <- df_wake_deseasonal_decomp[c(491:504)]

lowest_rmse<-Inf
lowest_mae<-Inf
best_mod<-NULL
best_mod_mae<-NULL

for (p in seq(1:4)){
  for (q in seq(1:4)){
    arima_mod_1 <- Arima(train_df1, order = c(p,1,q))
    forecast_fit <- forecast::forecast(arima_mod_1,h=14)
    rmse_mod_1 <- rmse(test_df1,forecast_fit$mean)
    if (rmse_mod_1 < lowest_rmse){
      lowest_rmse <- rmse_mod_1 
      best_mod <- arima_mod_1
    }
  }
} #arima(3,1,4) gives the lowest RMSE

lowest_rmse
best_mod

for (p in seq(1:4)){
  for (q in seq(1:4)){
    arima_mod_1 <- Arima(train_df1, order = c(p,1,q))
    forecast_fit <- forecast::forecast(arima_mod_1,h=14)
    mae_mod <- mae(test_df1,forecast_fit$mean)
    if (mae_mod < lowest_mae){
      lowest_mae <- mae_mod
      best_mod_mae <- arima_mod_1
    }
  }
} #arima(3,1,4) gives the lowest RMSE

best_mod_mae
lowest_mae

wake_fit_1_arima <- Arima(train_df1, order = c(4,1,4))
coeftest(wake_fit_1_arima)
wake_fit_1_arima_forecast <- forecast::forecast(wake_fit_1_arima,h=14)
rmse(test_df1,wake_fit_1_arima_forecast$mean)
mae(test_df1,wake_fit_1_arima_forecast$mean) 
checkresiduals(wake_fit_1_arima) 

exp(wake_fit_1_arima_forecast$mean[1])
exp(wake_fit_1_arima_forecast$lower[1,])
exp(wake_fit_1_arima_forecast$upper[1,])
exp(wake_fit_1_arima_forecast$mean[1])-exp(test_df1[1])

exp(test_df1[7])
exp(wake_fit_1_arima_forecast$mean[7])
exp(wake_fit_1_arima_forecast$lower[7,])
exp(wake_fit_1_arima_forecast$upper[7,])
exp(wake_fit_1_arima_forecast$mean[7])-exp(test_df1[7])

exp(wake_fit_1_arima_forecast$mean[14])
exp(wake_fit_1_arima_forecast$lower[14,])
exp(wake_fit_1_arima_forecast$upper[14,])
exp(wake_fit_1_arima_forecast$mean[14])-exp(test_df1[14])


wake_fit_2_arima  <- Arima(train_df1, order = c(3,1,4))
coeftest(wake_fit_2_arima)
wake_fit_2_arima_forecast <- forecast::forecast(wake_fit_2_arima ,h=14)
rmse(test_df1,wake_fit_2_arima_forecast$mean) 
mae(test_df1,wake_fit_2_arima_forecast$mean) 
checkresiduals(wake_fit_2_arima)

wake_fit_3_arima <- Arima(train_df1, order = c(3,1,1))
coeftest(wake_fit_3_arima)
wake_fit_3_arima_forecast <- forecast::forecast(wake_fit_3_arima,h=14)
rmse(test_df1,wake_fit_3_arima_forecast$mean) 
mae(test_df1,wake_fit_3_arima_forecast$mean) 
checkresiduals(wake_fit_3_arima)

wake_res_acf <- ggAcf(residuals(wake_fit_1_arima)) + 
  theme_bw(base_size = 15) + ggtitle("")

wake_qqplot <- data.frame(y=residuals(wake_fit_1_arima)) %>% 
  ggplot(aes(sample=y)) + geom_qq() + geom_qq_line() + 
  theme_bw(base_size = 15) + ylab("Sample Quantiles") + xlab("Theoretical Quantiles")

png(filename = "arima_res_wake.png", res = 700,
    units = "cm",width = 20, height = 10)
grid.arrange(wake_res_acf,wake_qqplot, ncol=2)
dev.off()

### Mecklenburg

mecklenburg_reported_cases <- subset(reported_cases,County=="Mecklenburg")
summary(mecklenburg_reported_cases)
mecklenburg_reported_cases$new_cases_per_10k <- 
  LOCF(mecklenburg_reported_cases$new_cases_per_10k)

df_mecklenburg <- mecklenburg_reported_cases %>% 
  group_by(Date) %>% 
  summarise(mean_new_cases = mean(new_cases_per_10k))
df_mecklenburg_1 <- xts(df_mecklenburg$mean_new_cases,order.by = df_mecklenburg$Date)
df_mecklenburg_1 <- df_mecklenburg_1[-c(1,506,507,508),] #making even weekly data
attr(df_mecklenburg_1, 'frequency') <- 7 
periodicity(df_mecklenburg_1)  
df_mecklenburg_1_ts <- as.ts(df_mecklenburg_1)
seasonal_decomp_mecklenburg<- decompose(log(df_mecklenburg_1_ts))
deseasonal_decomp_mecklen <- seasadj(seasonal_decomp_mecklenburg)

#Forecasting
train_df_seasonal_mecklen <- ts(log(df_mecklenburg_1_ts)[-c(491:504)], frequency=7)
test_df_seasonal_mecklen <- log(df_mecklenburg_1_ts)[c(491:504)]

train_df1_mecklen <- deseasonal_decomp_mecklen[-c(491:504)]
test_df1_mecklen <- deseasonal_decomp_mecklen[c(491:504)]

lowest_rmse_meck<-Inf
best_mod_meck<-NULL
lowest_mae_meck<-Inf
best_mod_meck_mae<-NULL

for (p in seq(1:4)){
  for (q in seq(1:4)){
    arima_mod_1 <- Arima(train_df1_mecklen, order = c(p,1,q))
    forecast_fit <- forecast::forecast(arima_mod_1,h=14)
    rmse_mod_1 <- rmse(test_df1_mecklen,forecast_fit$mean)
    if (rmse_mod_1 < lowest_rmse_meck){
      lowest_rmse_meck <- rmse_mod_1 
      best_mod_meck <- arima_mod_1
    }
  }
} #arima(3,1,1) gives the lowest RMSE 

best_mod_meck 
lowest_rmse_meck

for (p in seq(1:4)){
  for (q in seq(1:4)){
    arima_mod_1 <- Arima(train_df1_mecklen, order = c(p,1,q))
    forecast_fit <- forecast::forecast(arima_mod_1,h=14)
    mae_mod <- mae(test_df1_mecklen,forecast_fit$mean)
    if (mae_mod < lowest_mae_meck){
      lowest_mae_meck <- mae_mod
      best_mod_meck_mae <- arima_mod_1
    }
  }
} #arima(3,1,1) gives the lowest mae

best_mod_meck_mae 
lowest_mae_meck

meck_mod_1_arima <- Arima(train_df1_mecklen, order = c(4,1,4))
coeftest(meck_mod_1_arima)
meck_mod_1_arima_forecast <- forecast::forecast(meck_mod_1_arima , h=14)
rmse(test_df1_mecklen,meck_mod_1_arima_forecast$mean) 
mae(test_df1_mecklen,meck_mod_1_arima_forecast$mean) 
checkresiduals(meck_mod_1_arima)

exp(meck_mod_1_arima_forecast$mean[1])
exp(meck_mod_1_arima_forecast$lower[1,])
exp(meck_mod_1_arima_forecast$upper[1,])
exp(meck_mod_1_arima_forecast$mean[1])- exp(test_df1_mecklen[1])

exp(meck_mod_1_arima_forecast$mean[7])
exp(meck_mod_1_arima_forecast$lower[7,])
exp(meck_mod_1_arima_forecast$upper[7,])
exp(meck_mod_1_arima_forecast$mean[7])-exp(test_df1_mecklen[7])

exp(meck_mod_1_arima_forecast$mean[14])
exp(meck_mod_1_arima_forecast$lower[14,])
exp(meck_mod_1_arima_forecast$upper[14,])
exp(meck_mod_1_arima_forecast$mean[14])-exp(test_df1_mecklen[14])

meck_mod_2_arima <- Arima(train_df1_mecklen, order = c(3,1,4))
coeftest(meck_mod_2_arima)
meck_mod_2_arima_forecast <- forecast::forecast(meck_mod_2_arima , h=14)
rmse(test_df1_mecklen,meck_mod_2_arima_forecast$mean) 
mae(test_df1_mecklen,meck_mod_2_arima_forecast$mean) 
checkresiduals(meck_mod_2_arima)

meck_mod_3_arima <- Arima(train_df1_mecklen, order = c(3,1,1))
coeftest(meck_mod_3_arima)
meck_mod_3_arima_forecast <- forecast::forecast(meck_mod_3_arima , h=14)
rmse(test_df1_mecklen,meck_mod_3_arima_forecast$mean) 
mae(test_df1_mecklen,meck_mod_3_arima_forecast$mean) 
checkresiduals(meck_mod_3_arima)

meck_res_acf <- ggAcf(residuals(meck_mod_1_arima)) + 
  theme_bw(base_size = 15) + ggtitle("")

meck_qqplot <- data.frame(y=residuals(meck_mod_1_arima)) %>% 
  ggplot(aes(sample=y)) + geom_qq() + geom_qq_line() + 
  theme_bw(base_size = 15) + ylab("Sample Quantiles") + xlab("Theoretical Quantiles")

png(filename = "arima_res_meck.png", res = 700,
    units = "cm",width = 20, height = 10)
grid.arrange(meck_res_acf,meck_qqplot, ncol=2)
dev.off()

##New Hanover

new_hanover_reported_cases <- subset(reported_cases,County=="New Hanover")
summary(new_hanover_reported_cases)
new_hanover_reported_cases$new_cases_per_10k <- 
  LOCF(new_hanover_reported_cases$new_cases_per_10k)

df_new_hanover <- new_hanover_reported_cases %>% 
  group_by(Date) %>% 
  summarise(mean_new_cases = mean(new_cases_per_10k))
df_new_hanover_1 <- 
  xts(df_new_hanover$mean_new_cases,order.by = df_new_hanover$Date)
df_new_hanover_1 <- df_new_hanover_1[-c(1,506,507,508),] #making even weekly data
attr(df_new_hanover_1, 'frequency') <- 7 
periodicity(df_new_hanover_1)  
df_new_hanover_1_ts <- as.ts(df_new_hanover_1)

new_hanover_seasonal_decomp <- decompose(log(df_new_hanover_1_ts))
new_hanover_deseasonal_decomp <- seasadj(new_hanover_seasonal_decomp)

#forecasting

train_df_seasonal_new_hanover <- log(df_new_hanover_1_ts)[-c(491:504)]
test_df_seasonal_new_hanover <- log(df_new_hanover_1_ts)[c(491:504)]

train_df1_new_hanover<- new_hanover_deseasonal_decomp[-c(491:504)]
test_df1_new_hanover <- new_hanover_deseasonal_decomp[c(491:504)]

lowest_rmse_hanover<-Inf
best_mod_hanover<-NULL

for (p in seq(1:4)){
  for (q in seq(1:4)){
    arima_mod_1 <- Arima(train_df1_new_hanover, order = c(p,1,q))
    forecast_fit <- forecast::forecast(arima_mod_1,h=14)
    rmse_mod_1 <- rmse(test_df1_new_hanover,forecast_fit$mean)
    if (rmse_mod_1 < lowest_rmse_hanover){
      lowest_rmse_hanover <- rmse_mod_1 
      best_mod_hanover <- arima_mod_1
    }
  }
} 

best_mod_hanover #arima(4,1,4), arima(3,1,3)
lowest_rmse_hanover

lowest_mae_hanover<-Inf
best_mod_hanover_mae<-NULL

for (p in seq(1:4)){
  for (q in seq(1:4)){
    arima_mod_1 <- Arima(train_df1_new_hanover, order = c(p,1,q))
    forecast_fit <- forecast::forecast(arima_mod_1,h=14)
    mae_mod_1 <- mae(test_df1_new_hanover,forecast_fit$mean)
    if (mae_mod_1 < lowest_mae_hanover){
      lowest_mae_hanover <- mae_mod_1 
      best_mod_hanover_mae <- arima_mod_1
    }
  }
} 

best_mod_hanover_mae
lowest_mae_hanover
#since wake, meck have arima(4,1,4) as second best model out of the best models 
#considered, arima(4,1,4) will be used for comparision, allows to accomodate complex data 

new_hanover_mod_1_arima <- Arima(train_df1_new_hanover, order = c(3,1,1))
coeftest(new_hanover_mod_1_arima)
new_hanover_mod_1_arima_forecast <- forecast::forecast(new_hanover_mod_1_arima , h=14)
rmse(test_df1_new_hanover,new_hanover_mod_1_arima_forecast$mean) 
mae(test_df1_new_hanover,new_hanover_mod_1_arima_forecast$mean) 
checkresiduals(new_hanover_mod_1_arima)

new_hanover_mod_2_arima <- Arima(train_df1_new_hanover, order = c(3,1,4))
coeftest(new_hanover_mod_2_arima)
new_hanover_mod_2_arima_forecast <- forecast::forecast(new_hanover_mod_2_arima , h=14)
rmse(test_df1_new_hanover,new_hanover_mod_2_arima_forecast$mean) 
mae(test_df1_new_hanover,new_hanover_mod_2_arima_forecast$mean) 
checkresiduals(new_hanover_mod_2_arima)

new_hanover_mod_3_arima <- Arima(train_df1_new_hanover, order = c(4,1,4))
coeftest(new_hanover_mod_3_arima)
new_hanover_mod_3_arima_forecast <- forecast::forecast(new_hanover_mod_3_arima , h=14)
rmse(test_df1_new_hanover,new_hanover_mod_3_arima_forecast$mean) 
mae(test_df1_new_hanover,new_hanover_mod_3_arima_forecast$mean) 
checkresiduals(new_hanover_mod_3_arima)

exp(new_hanover_mod_3_arima_forecast$mean[1])
exp(new_hanover_mod_3_arima_forecast$lower[1,])
exp(new_hanover_mod_3_arima_forecast$upper[1,])
exp(new_hanover_mod_3_arima_forecast$mean[1])-exp(test_df1_new_hanover[1])

exp(new_hanover_mod_3_arima_forecast$mean[7])
exp(new_hanover_mod_3_arima_forecast$lower[7,])
exp(new_hanover_mod_3_arima_forecast$upper[7,])
exp(new_hanover_mod_3_arima_forecast$mean[7])-exp(test_df1_new_hanover[7])

exp(new_hanover_mod_3_arima_forecast$mean[14])
exp(new_hanover_mod_3_arima_forecast$lower[14,])
exp(new_hanover_mod_3_arima_forecast$upper[14,])
exp(new_hanover_mod_3_arima_forecast$mean[14])-exp(test_df1_new_hanover[14])


hanover_res_acf <- ggAcf(residuals(new_hanover_mod_3_arima)) + 
  theme_bw(base_size = 15) + ggtitle("")

hanover_qqplot <- data.frame(y=residuals(new_hanover_mod_3_arima)) %>% 
  ggplot(aes(sample=y)) + geom_qq() + geom_qq_line() + 
  theme_bw(base_size = 15) + ylab("Sample Quantiles") + xlab("Theoretical Quantiles")

png(filename = "arima_res_hanover.png", res = 700,
    units = "cm",width = 20, height = 10)
grid.arrange(hanover_res_acf,hanover_qqplot, ncol=2)
dev.off()

#forecasting plots

wake_forecast_plot <- 
  autoplot(wake_fit_1_arima_forecast) + 
  autolayer(wake_fit_1_arima_forecast, series = "Forecasted") +
  autolayer(ts(test_df1,start = 491), series = "Observed") +
  theme_bw() + ylab("") + 
  ggtitle(NULL) + theme(legend.position = "none") #wake

meck_forecast_plot <- 
  autoplot(meck_mod_1_arima_forecast) + 
  autolayer(meck_mod_1_arima_forecast, series = "Forecasted") +
  autolayer(ts(test_df1_mecklen,start = 491), series = "Observed") +
  theme_bw() + ylab("")  + 
  ggtitle(NULL) + theme(legend.position = "none") #meck

hanover_forecast_plot <- 
  autoplot(new_hanover_mod_3_arima_forecast) + 
  autolayer(new_hanover_mod_3_arima_forecast, series = "Forecasted") +
  autolayer(ts(test_df1_new_hanover,start = 491), series = "Observed") +
  theme_bw() + ylab("")+ 
  ggtitle(NULL) + theme(legend.position = "bottom")#new hanover

png(filename = "arima_forecasts.png",units = "cm",
    res = 700, width = 20, height = 15)
grid.arrange(wake_forecast_plot, meck_forecast_plot, 
             hanover_forecast_plot,
             left = text_grob("Logarithm of New COVID-19 cases per 10K", rot = 90, vjust = 1)) 
dev.off()

#forecasting ARIMA(3,1,1)

wake_forecast_plot_311 <- autoplot(wake_fit_3_arima_forecast) + 
  autolayer(wake_fit_3_arima_forecast, series = "Forecasted") +
  autolayer(ts(test_df1,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + xlab("")+
  ggtitle(NULL) + theme(legend.position = "none") #wake

meck_forecast_plot_311 <- autoplot(meck_mod_3_arima_forecast) + 
  autolayer(meck_mod_3_arima_forecast, series = "Forecasted") +
  autolayer(ts(test_df1_mecklen,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("")  + xlab("")+
  ggtitle(NULL) + theme(legend.position = "none") #meck

hanover_forecast_plot_311 <- 
  autoplot(new_hanover_mod_1_arima_forecast) + 
  autolayer(new_hanover_mod_1_arima_forecast, series = "Forecasted") +
  autolayer(ts(test_df1_new_hanover,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("")+ 
  ggtitle(NULL) + theme(legend.position = "bottom") #new hanover
```

## SARIMA modelling

```{r}
#Wake

best_sarima_mod <- NULL
lowest_sarima_mod_rmse <- Inf

for (p in seq(0,3)){
  for (d in seq(0,3)){
    for (q in seq(0,3)){
      for (P in seq(0,3)){
        for (D in seq(0,3)){
          for (Q in seq(0,3)){
            
    sarima_mod_1 <- Arima(train_df_seasonal, order = c(p,d,q),
                          seasonal = list(order=c(P,D,Q),period=7),
                          method="CSS")
    forecast_fit <- forecast::forecast(sarima_mod_1,14)
    rmse_mod <- rmse(test_df_seasonal,forecast_fit$mean)
    if (rmse_mod < lowest_sarima_mod_rmse){
      lowest_sarima_mod_rmse <- rmse_mod
      best_sarima_mod <- sarima_mod_1
    }
          }
        }
      }
    }
  }
}

best_sarima_mod
lowest_sarima_mod_rmse

best_sarima_mod_mae <- NULL
lowest_sarima_mod_mae <- Inf

for (p in seq(0,3)){
  for (d in seq(0,3)){
    for (q in seq(0,3)){
      for (P in seq(0,3)){
        for (D in seq(0,3)){
          for (Q in seq(0,3)){
            
            sarima_mod_1 <- Arima(train_df_seasonal, order = c(p,d,q),
                                  seasonal = list(order=c(P,D,Q),period=7),
                                  method="CSS")
            forecast_fit <- forecast::forecast(sarima_mod_1,14)
            mae_mod <- mae(test_df_seasonal,forecast_fit$mean)
            if (mae_mod < lowest_sarima_mod_mae){
              lowest_sarima_mod_mae <- mae_mod
              best_sarima_mod_mae <- sarima_mod_1
            }
          }
        }
      }
    }
  }
}

best_sarima_mod_mae 
lowest_sarima_mod_mae 

wake_sarima_mod_1 <- Arima(train_df_seasonal,
                         order = c(2,3,2), 
                         seasonal =c(1,1,2),method="CSS")
wake_sarima_mod_1_forecast<- forecast::forecast(wake_sarima_mod_1, h=14)
rmse(test_df_seasonal,wake_sarima_mod_1_forecast$mean)
mae(test_df_seasonal,wake_sarima_mod_1_forecast$mean)
checkresiduals(wake_sarima_mod_1)

exp(wake_sarima_mod_1_forecast$mean[1])
exp(wake_sarima_mod_1_forecast$lower[1,])
exp(wake_sarima_mod_1_forecast$upper[1,])
exp(wake_sarima_mod_1_forecast$mean[1])-exp(test_df_seasonal[1])

exp(wake_sarima_mod_1_forecast$mean[7])
exp(wake_sarima_mod_1_forecast$lower[7,])
exp(wake_sarima_mod_1_forecast$upper[7,])
exp(wake_sarima_mod_1_forecast$mean[7])-exp(test_df_seasonal[7])

exp(wake_sarima_mod_1_forecast$mean[14])
exp(wake_sarima_mod_1_forecast$lower[14,])
exp(wake_sarima_mod_1_forecast$upper[14,])
exp(wake_sarima_mod_1_forecast$mean[14])-exp(test_df_seasonal[14])


wake_sarima_mod_2 <- Arima(train_df_seasonal,
                           order = c(2,0,1), 
                           seasonal =c(1,1,2),method="CSS")
wake_sarima_mod_2_forecast<- forecast::forecast(wake_sarima_mod_2, h=14)
rmse(test_df_seasonal,wake_sarima_mod_2_forecast$mean)
mae(test_df_seasonal,wake_sarima_mod_2_forecast$mean)
checkresiduals(wake_sarima_mod_2)

wake_sarima_mod_3 <- Arima(train_df_seasonal,
                           order = c(2,3,2), 
                           seasonal =c(3,1,2),method="CSS")
wake_sarima_mod_3_forecast<- forecast::forecast(wake_sarima_mod_3, h=14)
rmse(test_df_seasonal,wake_sarima_mod_3_forecast$mean)
mae(test_df_seasonal,wake_sarima_mod_3_forecast$mean)
checkresiduals(wake_sarima_mod_3)

wake_res_acf_sarima <- ggAcf(residuals(wake_sarima_mod_1)) + 
  theme_bw(base_size = 15) + ggtitle("")

wake_qqplot_sarima <- data.frame(y=residuals(wake_sarima_mod_1)) %>% 
  ggplot(aes(sample=y)) + geom_qq() + geom_qq_line() + 
  theme_bw(base_size = 15) + ylab("Sample Quantiles") + xlab("Theoretical Quantiles")

grid.arrange(wake_res_acf_sarima ,wake_qqplot_sarima, ncol=2)

#Mecklenburg

best_sarima_mod_meck <- NULL
lowest_sarima_mod_meck_rmse <- Inf

for (p in seq(0,3)){
  for (d in seq(0,3)){
    for (q in seq(0,3)){
      for (P in seq(0,3)){
        for (D in seq(0,3)){
          for (Q in seq(0,3)){
            
            sarima_mod_1 <- Arima(train_df_seasonal_mecklen, order = c(p,d,q),
                                  seasonal = list(order=c(P,D,Q),period=7),
                                  method="CSS")
            forecast_fit <- forecast::forecast(sarima_mod_1,14)
            rmse_mod <- rmse(test_df_seasonal_mecklen,forecast_fit$mean)
            if (rmse_mod < lowest_sarima_mod_meck_rmse){
              lowest_sarima_mod_meck_rmse <- rmse_mod
              best_sarima_mod_meck <- sarima_mod_1
            }
          }
        }
      }
    }
  }
}

best_sarima_mod_meck
lowest_sarima_mod_meck_rmse

best_sarima_mod_mae_meck <- NULL
lowest_sarima_mod_meck_mae <- Inf

for (p in seq(0,3)){
  for (d in seq(0,3)){
    for (q in seq(0,3)){
      for (P in seq(0,3)){
        for (D in seq(0,3)){
          for (Q in seq(0,3)){
            
            sarima_mod_1 <- Arima(train_df_seasonal_mecklen, order = c(p,d,q),
                                  seasonal = list(order=c(P,D,Q),period=7),
                                  method="CSS")
            forecast_fit <- forecast::forecast(sarima_mod_1,14)
            mae_mod <- mae(test_df_seasonal_mecklen,forecast_fit$mean)
            if (mae_mod < lowest_sarima_mod_meck_mae){
              lowest_sarima_mod_meck_mae <- mae_mod
              best_sarima_mod_mae_meck <- sarima_mod_1
            }
          }
        }
      }
    }
  }
}

best_sarima_mod_mae_meck
lowest_sarima_mod_meck_mae 

meck_sarima_mod_1 <- Arima(train_df_seasonal_mecklen,
                         order = c(2,3,2), 
                         seasonal =c(1,1,2),method="CSS")
meck_sarima_mod_1_forecast <- forecast::forecast(meck_sarima_mod_1, h=14)
rmse(test_df_seasonal_mecklen,meck_sarima_mod_1_forecast$mean)
mae(test_df_seasonal_mecklen,meck_sarima_mod_1_forecast$mean)
checkresiduals(meck_sarima_mod_1)

exp(meck_sarima_mod_1_forecast$mean[1])
exp(meck_sarima_mod_1_forecast$lower[1,])
exp(meck_sarima_mod_1_forecast$upper[1,])
exp(meck_sarima_mod_1_forecast$mean[1])-exp(test_df_seasonal_mecklen[1])

exp(meck_sarima_mod_1_forecast$mean[7])
exp(meck_sarima_mod_1_forecast$lower[7,])
exp(meck_sarima_mod_1_forecast$upper[7,])
exp(meck_sarima_mod_1_forecast$mean[7])-exp(test_df_seasonal_mecklen[7])

exp(meck_sarima_mod_1_forecast$mean[14])
exp(meck_sarima_mod_1_forecast$lower[14,])
exp(meck_sarima_mod_1_forecast$upper[14,])
exp(meck_sarima_mod_1_forecast$mean[14])-exp(test_df_seasonal_mecklen[14])


meck_sarima_mod_2 <- Arima(train_df_seasonal_mecklen,
                           order = c(2,0,1), 
                           seasonal =c(1,1,2),method="CSS")
meck_sarima_mod_2_forecast <- forecast::forecast(meck_sarima_mod_2, h=14)
rmse(test_df_seasonal_mecklen,meck_sarima_mod_2_forecast$mean)
mae(test_df_seasonal_mecklen,meck_sarima_mod_2_forecast$mean)
checkresiduals(meck_sarima_mod_2)

meck_sarima_mod_3 <- Arima(train_df_seasonal_mecklen,
                           order = c(2,3,2), 
                           seasonal =c(3,1,2),method="CSS")
meck_sarima_mod_3_forecast <- forecast::forecast(meck_sarima_mod_3, h=14)
rmse(test_df_seasonal_mecklen,meck_sarima_mod_3_forecast$mean)
mae(test_df_seasonal_mecklen,meck_sarima_mod_3_forecast$mean)
checkresiduals(meck_sarima_mod_3)

meck_res_acf_sarima <- ggAcf(residuals(meck_sarima_mod_1)) + 
  theme_bw(base_size = 15) + ggtitle("")

meck_qqplot_sarima <- data.frame(y=residuals(meck_sarima_mod_1 )) %>% 
  ggplot(aes(sample=y)) + geom_qq() + geom_qq_line() + 
  theme_bw(base_size = 15) + ylab("Sample Quantiles") + xlab("Theoretical Quantiles")

grid.arrange(meck_res_acf_sarima ,meck_qqplot_sarima, ncol=2)

#New Hanover

best_sarima_mod_hanover <- NULL
lowest_sarima_mod_hanover_rmse <- Inf

for (p in seq(0,3)){
  for (d in seq(0,3)){
    for (q in seq(0,3)){
      for (P in seq(0,3)){
        for (D in seq(0,3)){
          for (Q in seq(0,3)){
            
            sarima_mod_1 <- Arima(train_df_seasonal_new_hanover, order = c(p,d,q),
                                  seasonal = list(order=c(P,D,Q),period=7),
                                  method="CSS")
            forecast_fit <- forecast::forecast(sarima_mod_1,14)
            rmse_mod <- rmse(test_df_seasonal_new_hanover,forecast_fit$mean)
            if (rmse_mod < lowest_sarima_mod_hanover_rmse){
              lowest_sarima_mod_hanover_rmse <- rmse_mod
              best_sarima_mod_hanover <- sarima_mod_1
            }
          }
        }
      }
    }
  }
}

best_sarima_mod_hanover
lowest_sarima_mod_hanover_rmse

best_sarima_mod_mae_hanover <- NULL
lowest_sarima_mod_hanover_mae <- Inf

for (p in seq(0,3)){
  for (d in seq(0,3)){
    for (q in seq(0,3)){
      for (P in seq(0,3)){
        for (D in seq(0,3)){
          for (Q in seq(0,3)){
            
            sarima_mod_1 <- Arima(train_df_seasonal_new_hanover, order = c(p,d,q),
                                  seasonal = list(order=c(P,D,Q),period=7),
                                  method="CSS")
            forecast_fit <- forecast::forecast(sarima_mod_1,14)
            mae_mod <- mae(test_df_seasonal_new_hanover,forecast_fit$mean)
            if (mae_mod < lowest_sarima_mod_hanover_mae){
              lowest_sarima_mod_hanover_mae <- mae_mod
              best_sarima_mod_mae_hanover <- sarima_mod_1
            }
          }
        }
      }
    }
  }
}

best_sarima_mod_mae_hanover
lowest_sarima_mod_hanover_mae 

hanover_sarima_mod_1 <- Arima(train_df_seasonal_new_hanover,
                           order = c(2,3,2), 
                           seasonal =c(1,1,2),method="CSS")
hanover_sarima_mod_1_forecast <- forecast::forecast(hanover_sarima_mod_1, h=14)
rmse(test_df_seasonal_new_hanover,hanover_sarima_mod_1_forecast$mean)
mae(test_df_seasonal_new_hanover,hanover_sarima_mod_1_forecast$mean)
checkresiduals(hanover_sarima_mod_1)

exp(hanover_sarima_mod_1_forecast$mean[1])
exp(hanover_sarima_mod_1_forecast$lower[1,])
exp(hanover_sarima_mod_1_forecast$upper[1,])
exp(hanover_sarima_mod_1_forecast$mean[1])-exp(test_df1_new_hanover[1])

exp(hanover_sarima_mod_1_forecast$mean[7])
exp(hanover_sarima_mod_1_forecast$lower[7,])
exp(hanover_sarima_mod_1_forecast$upper[7,])
exp(hanover_sarima_mod_1_forecast$mean[7])-exp(test_df1_new_hanover[7])

exp(hanover_sarima_mod_1_forecast$mean[14])
exp(hanover_sarima_mod_1_forecast$lower[14,])
exp(hanover_sarima_mod_1_forecast$upper[14,])
exp(hanover_sarima_mod_1_forecast$mean[14])-exp(test_df1_new_hanover[14])

hanover_sarima_mod_2 <- Arima(train_df_seasonal_new_hanover,
                           order = c(2,0,1), 
                           seasonal =c(1,1,2),method="CSS")
hanover_sarima_mod_2_forecast <- forecast::forecast(hanover_sarima_mod_2, h=14)
rmse(test_df_seasonal_new_hanover,hanover_sarima_mod_2_forecast$mean)
mae(test_df_seasonal_new_hanover,hanover_sarima_mod_2_forecast$mean)
checkresiduals(hanover_sarima_mod_2)

hanover_sarima_mod_3 <- Arima(train_df_seasonal_new_hanover,
                              order = c(2,3,2), 
                              seasonal =c(3,1,2),method="CSS")
hanover_sarima_mod_3_forecast <- forecast::forecast(hanover_sarima_mod_3, h=14)
rmse(test_df_seasonal_new_hanover,hanover_sarima_mod_3_forecast$mean)
mae(test_df_seasonal_new_hanover,hanover_sarima_mod_3_forecast$mean)
checkresiduals(hanover_sarima_mod_3)


hanover_res_acf_sarima <- ggAcf(residuals(hanover_sarima_mod_1)) + 
  theme_bw(base_size = 15) + ggtitle("")

hanover_qqplot_sarima <- data.frame(y=residuals(hanover_sarima_mod_1)) %>% 
  ggplot(aes(sample=y)) + geom_qq() + geom_qq_line() + 
  theme_bw(base_size = 15) + ylab("Sample Quantiles") + xlab("Theoretical Quantiles")

grid.arrange(hanover_res_acf_sarima ,hanover_qqplot_sarima, ncol=2)

#Forecasting plots

wake_forecast_plot_sarima <- autoplot(wake_sarima_mod_1_forecast) + 
  autolayer(wake_sarima_mod_1_forecast, series = "Forecasted") +
  autolayer(ts(test_df_seasonal,start = 71,frequency = 7), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") +
  ggtitle(NULL) + theme(legend.position = "none") #wake

meck_forecast_plot_sarima <- autoplot(meck_sarima_mod_1_forecast) + 
  autolayer(meck_sarima_mod_1_forecast, series = "Forecasted") +
  autolayer(ts(test_df_seasonal_mecklen,start = 71,frequency = 7), series = "Observed") +
  theme_bw(base_size = 15) + ylab("")  + 
  ggtitle(NULL) + theme(legend.position = "none") #meck

hanover_forecast_plot_sarima <- 
  autoplot(hanover_sarima_mod_1_forecast) + 
  autolayer(hanover_sarima_mod_1_forecast, series = "Forecasted") +
  autolayer(ts(test_df_seasonal_new_hanover,start = 71,frequency = 7), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") +
  ggtitle(NULL) + theme(legend.position = "bottom") #new hanover

png(filename = "sarima_forecasts.png",units = "cm",
    res = 700, width = 20, height = 15)
grid.arrange(wake_forecast_plot_sarima, meck_forecast_plot_sarima, 
             hanover_forecast_plot_sarima,
             left = text_grob("Logarithm of New COVID-19 cases per 10K", rot = 90, vjust = 1)) 
dev.off()
```

# Incorporating wastewater and weather information

## ARIMAX modelling- wastewater information only

```{r}
#wake#

cases <- xts(full_cases_wastewater_weather_data$mean_new_cases,
    order.by = full_cases_wastewater_data$Date)
attr(cases , 'frequency') <- 7 
cases <- cases[-c(505,506,507)]
cases <- as.ts(cases)
cases_decompose <- decompose(log(cases))
cases_deseasonalise <- seasadj(cases_decompose)

viral_gene <- xts(full_cases_wastewater_weather_data$full_viral_gene_copies_per_person,
                  order.by = full_cases_wastewater_data$Date)
attr(viral_gene , 'frequency') <- 7 
viral_gene  <- viral_gene[-c(505,506,507)]
viral_gene  <- as.ts(viral_gene)
viral_decompose <- decompose(log(viral_gene))
viral_deseasonalise <- seasadj(viral_decompose)

cases_train <- cases_deseasonalise[-c(491:504)]
cases_test <- cases_deseasonalise[c(491:504)]

viral_train <- viral_deseasonalise[-c(491:504)]
viral_test <- viral_deseasonalise[c(491:504)]

wastewater_mod_1_wake <- Arima(cases_train ,order = c(3,1,1),
                                xreg = viral_train)
coeftest(wastewater_mod_1_wake) # weakly insignificant
forecast_mod_1_wake <- forecast::forecast(wastewater_mod_1_wake, h=14,
                           xreg = viral_test)
rmse(cases_test,forecast_mod_1_wake$mean) #0.31
mae(cases_test,forecast_mod_1_wake$mean) #0.29
checkresiduals(wastewater_mod_1_wake)
  

wastewater_mod_2_wake <- Arima(cases_train ,order = c(4,1,4),
                               xreg = viral_train)
coeftest(wastewater_mod_2_wake) # weakly insignificant
forecast_mod_2_wake <- forecast::forecast(wastewater_mod_2_wake, h=14,
                           xreg = viral_test)
rmse(cases_test,forecast_mod_2_wake$mean)
mae(cases_test,forecast_mod_2_wake$mean) 
checkresiduals(wastewater_mod_2_wake)

exp(forecast_mod_2_wake$mean[1])
exp(forecast_mod_2_wake$lower[1,])
exp(forecast_mod_2_wake$upper[1,])
exp(forecast_mod_2_wake$mean[1]) - exp(cases_test[1])

exp(forecast_mod_2_wake$mean[7])
exp(forecast_mod_2_wake$lower[7,])
exp(forecast_mod_2_wake$upper[7,])
exp(forecast_mod_2_wake$mean[7])-exp(cases_test[7])

exp(forecast_mod_2_wake$mean[14])
exp(forecast_mod_2_wake$lower[14,])
exp(forecast_mod_2_wake$upper[14,])
exp(forecast_mod_2_wake$mean[14])-exp(cases_test[14])

#Mecklenburg#

glimpse(full_cases_wastewater_weather_data_meck)
cases_meck <- xts(full_cases_wastewater_weather_data_meck$mean_new_cases,
             order.by = full_cases_wastewater_data_meck$Date)
attr(cases_meck , 'frequency') <- 7 
cases_meck <- cases_meck[-c(505,506,507)]
cases_meck <- as.ts(cases_meck)
cases_decompose_meck <- decompose(log(cases_meck))
cases_deseasonalise_meck <- seasadj(cases_decompose_meck)

viral_gene_meck <- xts(full_cases_wastewater_weather_data_meck$full_viral_gene_copies_per_person,
                  order.by = full_cases_wastewater_data_meck$Date)
attr(viral_gene_meck , 'frequency') <- 7 
viral_gene_meck  <- viral_gene_meck[-c(505,506,507)]
viral_gene_meck  <- as.ts(viral_gene_meck)
viral_decompose_meck <- decompose(log(viral_gene_meck))
viral_deseasonalise_meck <- seasadj(viral_decompose_meck)

cases_train_meck <- cases_deseasonalise_meck[-c(491:504)]
cases_test_meck <- cases_deseasonalise_meck[c(491:504)]

viral_train_meck <- viral_deseasonalise_meck[-c(491:504)]
viral_test_meck <- viral_deseasonalise_meck[c(491:504)]

wastewater_mod_1_meck <- Arima(cases_train_meck,order = c(3,1,1),
                               xreg = viral_train_meck)
coeftest(wastewater_mod_1_meck ) #wastewater insignificant
forecast_mod_1_meck <- forecast::forecast(wastewater_mod_1_meck, h=14,
                           xreg = viral_test_meck)
rmse(cases_test_meck,forecast_mod_1_meck$mean) 
mae(cases_test_meck,forecast_mod_1_meck$mean) 
checkresiduals(wastewater_mod_1_meck) #wastewater improves forecast

wastewater_mod_2_meck <- Arima(cases_train_meck ,order = c(4,1,4),
                               xreg = viral_train_meck, method = "CSS")
coeftest(wastewater_mod_2_meck) #insignificant
forecast_mod_2_meck <- forecast::forecast(wastewater_mod_2_meck, h=14,
                           xreg = viral_test_meck)
rmse(cases_test_meck,forecast_mod_2_meck$mean) 
mae(cases_test_meck,forecast_mod_2_meck$mean) 
checkresiduals(wastewater_mod_2_meck) #wastewater does not improve forecast

exp(forecast_mod_2_meck$mean[1])
exp(forecast_mod_2_meck$lower[1,])
exp(forecast_mod_2_meck$upper[1,])
exp(forecast_mod_2_meck$mean[1])-exp(cases_test_meck[1])

exp(forecast_mod_2_meck$mean[7])
exp(forecast_mod_2_meck$lower[7,])
exp(forecast_mod_2_meck$upper[7,])
exp(forecast_mod_2_meck$mean[7])-exp(cases_test_meck[7])

exp(forecast_mod_2_meck$mean[14])
exp(forecast_mod_2_meck$lower[14,])
exp(forecast_mod_2_meck$upper[14,])
exp(forecast_mod_2_meck$mean[14])-exp(cases_test_meck[14])

#new hanover#

glimpse(full_cases_wastewater_weather_data_hanover)
cases_hanover <- xts(full_cases_wastewater_weather_data_hanover$mean_new_cases,
                  order.by = full_cases_wastewater_data_hanover$Date)
attr(cases_hanover , 'frequency') <- 7 
cases_hanover <- cases_hanover[-c(505,506,507)]
cases_hanover <- as.ts(cases_hanover)
cases_decompose_hanover <- decompose(log(cases_hanover))
cases_deseasonalise_hanover <- seasadj(cases_decompose_hanover)

viral_gene_hanover <- xts(full_cases_wastewater_weather_data_hanover$full_viral_gene_copies_per_person,
                       order.by = full_cases_wastewater_data_hanover$Date)
attr(viral_gene_hanover , 'frequency') <- 7 
viral_gene_hanover  <- viral_gene_hanover[-c(505,506,507)]
viral_gene_hanover  <- as.ts(viral_gene_hanover)
viral_decompose_hanover <- decompose(log(viral_gene_hanover))
viral_deseasonalise_hanover <- seasadj(viral_decompose_hanover)

cases_train_hanover <- cases_deseasonalise_hanover[-c(491:504)]
cases_test_hanover <- cases_deseasonalise_hanover[c(491:504)]

viral_train_hanover <- viral_deseasonalise_hanover[-c(491:504)]
viral_test_hanover <- viral_deseasonalise_hanover[c(491:504)]

wastewater_mod_1_hanover <- Arima(cases_train_hanover ,order = c(3,1,1),
                                  xreg = viral_train_hanover)
coeftest(wastewater_mod_1_hanover) #wastewater insignificant
forecast_mod_1_hanover <- forecast::forecast(wastewater_mod_1_hanover, h=14,
                                             xreg = viral_test_hanover)
rmse(cases_test_hanover,forecast_mod_1_hanover$mean) 
mae(cases_test_hanover,forecast_mod_1_hanover$mean) 
checkresiduals(wastewater_mod_1_hanover) #not improve forecast


wastewater_mod_1_hanover <- Arima(cases_train_hanover ,order = c(4,1,4),
                               xreg = viral_train_hanover)
coeftest(wastewater_mod_1_hanover) #wastewater insignificant
forecast_mod_1_hanover <- forecast::forecast(wastewater_mod_1_hanover, h=14,
                                xreg = viral_test_hanover)
rmse(cases_test_hanover,forecast_mod_1_hanover$mean) 
mae(cases_test_hanover,forecast_mod_1_hanover$mean) 
checkresiduals(wastewater_mod_1_hanover) #not improve forecast

#arimax(4,1,4) plots with only wastewater information#

arimax_414_plot_wake <- autoplot(forecast_mod_2_wake) + 
  autolayer(forecast_mod_2_wake, series = "Forecasted") +
  autolayer(ts(cases_test,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + xlab("Time") +
  ggtitle(NULL) + theme(legend.position = "none") #wake

arimax_414_plot_meck <- autoplot(forecast_mod_2_meck) + 
  autolayer(forecast_mod_2_meck, series = "Forecasted") +
  autolayer(ts(cases_test_meck,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + xlab("Time") +
  ggtitle(NULL) + theme(legend.position = "none") 

arimax_414_plot_hanover <- autoplot(forecast_mod_1_hanover) + 
  autolayer(forecast_mod_1_hanover, series = "Forecasted") +
  autolayer(ts(cases_test_hanover,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + xlab("Time") +
  ggtitle(NULL) + theme(legend.position = "bottom") 

png(filename = "arimax414_plots.png", res = 700, units = "cm",
    width = 20, height = 18)
grid.arrange(arimax_414_plot_wake,
             arimax_414_plot_meck,
             arimax_414_plot_hanover,
             left = text_grob("Logarithm of New COVID-19 cases per 10K", rot = 90, vjust = 1))
dev.off()

```

## ARIMAX modelling - wastewater and weather information 

```{r}
#wake#

precipation_wake <- xts(full_cases_wastewater_weather_data$mean_precipation,
                        order.by = full_cases_wastewater_weather_data$Date)
attr(precipation_wake,'frequency') <- 7
precipation_wake <- precipation_wake[-c(505,506,507)]
precipation_wake <- as.ts(precipation_wake)

temp_wake <- xts(full_cases_wastewater_weather_data$TAVG,
                 order.by = full_cases_wastewater_weather_data$Date)
attr(temp_wake,'frequency') <- 7
temp_wake <- temp_wake[-c(505,506,507)]
temp_wake <- as.ts(temp_wake)

precipation_wake_train <- ts(precipation_wake[-c(491:504)])
precipation_wake_test <- ts(precipation_wake[c(491:504)])

temp_wake_train <- ts(temp_wake[-c(491:504)])
temp_wake_test <- ts(temp_wake[c(491:504)])

vars_wake <- ts.union(viral_train,precipation_wake_train,
                 temp_wake_train)

vars_test_wake <- ts.union(viral_test,precipation_wake_test,
                      temp_wake_test)

wastewater_weather_mod_1_wake <- Arima(cases_train ,order = c(3,1,1),
                               xreg = vars_wake)
coeftest(wastewater_weather_mod_1_wake) # weakly insignificant
forecast_mod_1_wake <- forecast::forecast(wastewater_weather_mod_1_wake, h=14,
                           xreg = vars_test_wake)
rmse(cases_test,forecast_mod_1_wake$mean) 
mae(cases_test,forecast_mod_1_wake$mean) 
checkresiduals(wastewater_weather_mod_1_wake)

wastewater_weather_mod_2_wake <- Arima(cases_train ,order = c(4,1,4),
                               xreg = vars_wake)
coeftest(wastewater_weather_mod_2_wake) # insignificant
forecast_mod_2_wake <- forecast::forecast(wastewater_weather_mod_2_wake, h=14,
                           xreg = vars_test_wake)
rmse(cases_test,forecast_mod_2_wake$mean) 
mae(cases_test,forecast_mod_2_wake$mean)
checkresiduals(wastewater_weather_mod_2_wake)

exp(forecast_mod_2_wake$mean[1])
exp(forecast_mod_2_wake$lower[1,])
exp(forecast_mod_2_wake$upper[1,])
exp(forecast_mod_2_wake$mean[1])-exp(cases_test[1])

exp(forecast_mod_2_wake$mean[7])
exp(forecast_mod_2_wake$lower[7,])
exp(forecast_mod_2_wake$upper[7,])
exp(forecast_mod_2_wake$mean[7])-exp(cases_test[7])

exp(forecast_mod_2_wake$mean[14])
exp(forecast_mod_2_wake$lower[14,])
exp(forecast_mod_2_wake$upper[14,])
exp(forecast_mod_2_wake$mean[14]) -exp(cases_test[14])

wake_forecast_arimax_weather_plot <- autoplot(forecast_mod_1_wake) + 
  autolayer(forecast_mod_1_wake, series = "Forecasted") +
  autolayer(ts(cases_test,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + 
  xlab("") + ggtitle(NULL) + theme(legend.position = "none") 

#mecklenburg#

precipation_meck <- xts(full_cases_wastewater_weather_data_meck$mean_precipation,
                        order.by = full_cases_wastewater_weather_data_meck$Date)
attr(precipation_meck,'frequency') <- 7
precipation_meck <- precipation_meck[-c(505,506,507)]
precipation_meck <- as.ts(precipation_meck)

temp_meck <- xts(full_cases_wastewater_weather_data_meck$TAVG,
                 order.by = full_cases_wastewater_weather_data_meck$Date)
attr(temp_meck,'frequency') <- 7
temp_meck <- temp_meck[-c(505,506,507)]
temp_meck <- as.ts(temp_meck)

precipation_meck_train <- ts(precipation_meck[-c(491:504)])
precipation_meck_test <- ts(precipation_meck[c(491:504)])

temp_meck_train <- ts(temp_meck[-c(491:504)])
temp_meck_test <- ts(temp_meck[c(491:504)])

vars_meck <- ts.union(viral_train_meck,precipation_meck_train,
                 temp_meck_train)

vars_test_meck <- ts.union(viral_test_meck,precipation_meck_test,
                      temp_meck_test)

wastewater_weather_mod_1_meck <- Arima(cases_train_meck ,order = c(3,1,1),
                                       xreg = vars_meck)
coeftest(wastewater_weather_mod_1_meck) # weakly insignificant
forecast_mod_1_meck <- forecast::forecast(wastewater_weather_mod_1_meck, h=14,
                           xreg = vars_test_meck)
rmse(cases_test_meck,forecast_mod_1_meck$mean) 
mae(cases_test_meck,forecast_mod_1_meck$mean) 
checkresiduals(wastewater_weather_mod_1_meck)


wastewater_weather_mod_2_meck <- Arima(cases_train_meck ,order = c(4,1,4),
                                       xreg = vars_meck, method = "CSS")
coeftest(wastewater_weather_mod_2_meck) # insignificant
forecast_mod_2_meck <- forecast::forecast(wastewater_weather_mod_2_meck, h=14,
                           xreg = vars_test_meck)
rmse(cases_test_meck,forecast_mod_2_meck$mean) 
mae(cases_test_meck,forecast_mod_2_meck$mean) 
checkresiduals(wastewater_weather_mod_2_meck)

exp(forecast_mod_2_meck$mean[1])
exp(forecast_mod_2_meck$lower[1,])
exp(forecast_mod_2_meck$upper[1,])
exp(forecast_mod_2_meck$mean[1])-exp(cases_test_meck[1])

exp(forecast_mod_2_meck$mean[7])
exp(forecast_mod_2_meck$lower[7,])
exp(forecast_mod_2_meck$upper[7,])
exp(forecast_mod_2_meck$mean[7])-exp(cases_test_meck[7])

exp(forecast_mod_2_meck$mean[14])
exp(forecast_mod_2_meck$lower[14,])
exp(forecast_mod_2_meck$upper[14,])
exp(forecast_mod_2_meck$mean[14]) -exp(cases_test_meck[14])

meck_forecast_arimax_weather_plot <- autoplot(forecast_mod_1_meck) + 
  autolayer(forecast_mod_1_meck, series = "Forecasted") +
  autolayer(ts(cases_test_meck,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + 
  xlab("") + ggtitle(NULL) + theme(legend.position = "none") #wake

#new hanover#

precipation_hanover <- xts(full_cases_wastewater_weather_data_hanover$mean_precipation,
                        order.by = full_cases_wastewater_weather_data_hanover$Date)
attr(precipation_hanover,'frequency') <- 7
precipation_hanover <- precipation_hanover[-c(505,506,507)]
precipation_hanover <- as.ts(precipation_hanover)
precipation_hanover

temp_hanover<- xts(full_cases_wastewater_weather_data_hanover$mean_temp,
                 order.by = full_cases_wastewater_weather_data_hanover$Date)
attr(temp_hanover,'frequency') <- 7
temp_hanover <- temp_hanover[-c(505,506,507)]
temp_hanover <- as.ts(temp_hanover)
temp_hanover

precipation_hanover_train <- ts(precipation_hanover[-c(491:504)])
precipation_hanover_test <- ts(precipation_hanover[c(491:504)])

temp_hanover_train <- ts(temp_hanover[-c(491:504)])
temp_hanover_test <- ts(temp_hanover[c(491:504)])

vars_hanover <- ts.union(viral_train_hanover,precipation_hanover_train,
                 temp_hanover_train)

vars_test_hanover <- ts.union(viral_test_hanover,precipation_hanover_test,
                      temp_hanover_test)

wastewater_weather_mod_1_hanover <- Arima(cases_train_hanover ,order = c(3,1,1),
                                          xreg = vars_hanover)
coeftest(wastewater_weather_mod_1_hanover) # weakly insignificant
forecast_mod_1_hanover <- forecast::forecast(wastewater_weather_mod_1_hanover, h=14,
                                     xreg = vars_test_hanover)
rmse(cases_test_hanover,forecast_mod_1_hanover$mean) 
mae(cases_test_hanover,forecast_mod_1_hanover$mean) 
checkresiduals(wastewater_weather_mod_1_hanover)

wastewater_weather_mod_2_hanover <- Arima(cases_train_hanover ,order = c(4,1,4),
                                       xreg = vars_hanover)
coeftest(wastewater_weather_mod_2_hanover) # weakly insignificant
forecast_mod_2_hanover <- forecast::forecast(wastewater_weather_mod_2_hanover, h=14,
                           xreg = vars_test_hanover)
rmse(cases_test_hanover,forecast_mod_2_hanover$mean) 
mae(cases_test_hanover,forecast_mod_2_hanover$mean) 
checkresiduals(wastewater_weather_mod_2_hanover)

exp(forecast_mod_2_hanover$mean[1])
exp(forecast_mod_2_hanover$lower[1,])
exp(forecast_mod_2_hanover$upper[1,])
exp(forecast_mod_2_hanover$mean[1])-exp(cases_test_hanover[1])

exp(forecast_mod_2_hanover$mean[7])
exp(forecast_mod_2_hanover$lower[7,])
exp(forecast_mod_2_hanover$upper[7,])
exp(forecast_mod_2_hanover$mean[7])-exp(cases_test_hanover[7])

exp(forecast_mod_2_hanover$mean[14])
exp(forecast_mod_2_hanover$lower[14,])
exp(forecast_mod_2_hanover$upper[14,])
exp(forecast_mod_2_hanover$mean[14]) -exp(cases_test_hanover[14])

hanover_forecast_arimax_weather_plot <- autoplot(forecast_mod_1_hanover) + 
  autolayer(forecast_mod_1_hanover, series = "Forecasted") +
  autolayer(ts(cases_test_hanover,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + 
  xlab("Time")+ ggtitle(NULL) + theme(legend.position = "bottom") 

```

## SARIMAX- wastewater information only

```{r}

cases_train_seasonal <- log(cases)[-c(491:504)]
cases_test_seasonal <- log(cases)[c(491:504)]

viral_train_seasonal <- log(viral_gene)[-c(491:504)]
viral_test_seasonal <- log(viral_gene)[c(491:504)]

wastewater_mod_sarimax_wake <- Arima(cases_train_seasonal,
                                    order = c(2,3,2),
                                    seasonal = list(order=c(1,1,2),period=7),
                                    xreg = viral_train_seasonal)
coeftest(wastewater_mod_sarimax_wake)
forecast_sarimax_wake <- forecast::forecast(wastewater_mod_sarimax_wake, h=14,
                                 xreg = viral_test_seasonal)
rmse(cases_test_seasonal,forecast_sarimax_wake$mean) 
mae(cases_test_seasonal,forecast_sarimax_wake$mean) 
checkresiduals(wastewater_mod_sarimax_wake)

exp(forecast_sarimax_wake$mean[1])
exp(forecast_sarimax_wake$lower[1,])
exp(forecast_sarimax_wake$upper[1,])
exp(forecast_sarimax_wake$mean[1])-exp(cases_test_seasonal[1])

exp(forecast_sarimax_wake$mean[7])
exp(forecast_sarimax_wake$lower[7,])
exp(forecast_sarimax_wake$upper[7,])
exp(forecast_sarimax_wake$mean[7])-exp(cases_test_seasonal[7])

exp(forecast_sarimax_wake$mean[14])
exp(forecast_sarimax_wake$lower[14,])
exp(forecast_sarimax_wake$upper[14,])
exp(forecast_sarimax_wake$mean[14]) -exp(cases_test_seasonal[14])

#mecklenburg

cases_train_meck_seasonal <- log(cases_meck)[-c(491:504)]
cases_test_meck_seasonal <- log(cases_meck)[c(491:504)]

viral_train_meck_seasonal <- log(viral_gene_meck)[-c(491:504)]
viral_test_meck_seasonal <- log(viral_gene_meck)[c(491:504)]

wastewater_mod_sarimax_meck <- Arima(cases_train_meck_seasonal,
                                    order = c(2,3,2),
                                    seasonal = list(order=c(1,1,2),period=7),
                                    xreg = viral_train_meck_seasonal,
                                    method = "CSS")
coeftest(wastewater_mod_sarimax_meck)
forecast_sarimax_meck <- forecast::forecast(wastewater_mod_sarimax_meck, h=14,
                                 xreg = viral_test_meck_seasonal)
rmse(cases_test_meck_seasonal,forecast_sarimax_meck$mean) 
mae(cases_test_meck_seasonal,forecast_sarimax_meck$mean) 
checkresiduals(wastewater_mod_sarimax_meck)

exp(forecast_sarimax_meck$mean[1])
exp(forecast_sarimax_meck$lower[1,])
exp(forecast_sarimax_meck$upper[1,])
exp(forecast_sarimax_meck$mean[1])-exp(cases_test_meck_seasonal[1])

exp(forecast_sarimax_meck$mean[7])
exp(forecast_sarimax_meck$lower[7,])
exp(forecast_sarimax_meck$upper[7,])
exp(forecast_sarimax_meck$mean[7])-exp(cases_test_meck_seasonal[7])

exp(forecast_sarimax_meck$mean[14])
exp(forecast_sarimax_meck$lower[14,])
exp(forecast_sarimax_meck$upper[14,])
exp(forecast_sarimax_meck$mean[14]) -exp(cases_test_meck_seasonal[14])

#new hanover

cases_train_hanover_seasonal <- log(cases_hanover)[-c(491:504)]
cases_test_hanover_seasonal <- log(cases_hanover)[c(491:504)]

viral_train_hanover_seasonal <- log(viral_gene_hanover)[-c(491:504)]
viral_test_hanover_seasonal <- log(viral_gene_hanover)[c(491:504)]

wastewater_mod_sarimax_hanover <- Arima(cases_train_hanover_seasonal,
                                    order = c(2,3,2),
                                    seasonal = list(order=c(1,1,2),period=7),
                                    xreg = viral_train_hanover_seasonal,method = "CSS")
coeftest(wastewater_mod_sarimax_hanover)
forecast_sarimax_hanover <- forecast::forecast(wastewater_mod_sarimax_hanover, h=14,
                                 xreg = viral_test_hanover_seasonal)
rmse(cases_test_hanover_seasonal,forecast_sarimax_hanover$mean) 
mae(cases_test_hanover_seasonal,forecast_sarimax_hanover$mean) 
checkresiduals(wastewater_mod_sarimax_hanover)

exp(forecast_sarimax_hanover $mean[1])
exp(forecast_sarimax_hanover $lower[1,])
exp(forecast_sarimax_hanover $upper[1,])
exp(forecast_sarimax_hanover $mean[1])-exp(cases_test_hanover_seasonal[1])

exp(forecast_sarimax_hanover $mean[7])
exp(forecast_sarimax_hanover $lower[7,])
exp(forecast_sarimax_hanover $upper[7,])
exp(forecast_sarimax_hanover $mean[7])-exp(cases_test_hanover_seasonal[7])

exp(forecast_sarimax_hanover $mean[14])
exp(forecast_sarimax_hanover $lower[14,])
exp(forecast_sarimax_hanover $upper[14,])
exp(forecast_sarimax_hanover $mean[14]) -exp(cases_test_hanover_seasonal[14])

```

## SARIMAX modelling- Wastewater and weather information

```{r}
#wake 

vars_weather_wake <- ts.union(viral_train_seasonal,precipation_wake_train,
                 temp_wake_train)

vars_test_weather_wake <- ts.union(viral_test_seasonal,precipation_wake_test,
                      temp_wake_test)

wastewater_weather_mod_sarimax_wake <- Arima(cases_train_seasonal,
                                    order = c(2,3,2),
                                    seasonal = list(order=c(1,1,2),period=7),
                                    xreg = vars_weather_wake)
coeftest(wastewater_weather_mod_sarimax_wake)
forecast_sarimax_wake <- forecast::forecast(wastewater_weather_mod_sarimax_wake, h=14,
                                 xreg = vars_test_weather_wake)
rmse(cases_test_seasonal,forecast_sarimax_wake$mean) 
mae(cases_test_seasonal,forecast_sarimax_wake$mean) 
checkresiduals(wastewater_weather_mod_sarimax_wake)

exp(forecast_sarimax_wake$mean[1])
exp(forecast_sarimax_wake$lower[1,])
exp(forecast_sarimax_wake$upper[1,])
exp(forecast_sarimax_wake$mean[1])-exp(cases_test_seasonal[1])

exp(forecast_sarimax_wake$mean[7])
exp(forecast_sarimax_wake$lower[7,])
exp(forecast_sarimax_wake$upper[7,])
exp(forecast_sarimax_wake$mean[7])-exp(cases_test_seasonal[7])

exp(forecast_sarimax_wake$mean[14])
exp(forecast_sarimax_wake$lower[14,])
exp(forecast_sarimax_wake$upper[14,])
exp(forecast_sarimax_wake$mean[14]) -exp(cases_test_seasonal[14])

#mecklenburg

vars_weather_meck <- ts.union(viral_train_meck_seasonal,precipation_meck_train,
                 temp_meck_train)

vars_test_weather_meck <- ts.union(viral_test_meck_seasonal,precipation_meck_test,
                      temp_meck_test)

wastewater_weather_mod_sarimax_meck <- Arima(cases_train_meck_seasonal,
                                    order = c(2,3,2),
                                    seasonal = list(order=c(1,1,2),period=7),
                                    xreg = vars_weather_meck,method = "CSS")
coeftest(wastewater_weather_mod_sarimax_meck)
forecast_sarimax_meck <- forecast::forecast(wastewater_weather_mod_sarimax_meck, h=14,
                                 xreg = vars_test_weather_meck)
rmse(cases_test_meck_seasonal,forecast_sarimax_meck$mean) 
mae(cases_test_meck_seasonal,forecast_sarimax_meck$mean) 
checkresiduals(wastewater_weather_mod_sarimax_meck)

exp(forecast_sarimax_meck $mean[1])
exp(forecast_sarimax_meck $lower[1,])
exp(forecast_sarimax_meck $upper[1,])
exp(forecast_sarimax_meck $mean[1])-exp(cases_test_meck_seasonal[1])

exp(forecast_sarimax_meck $mean[7])
exp(forecast_sarimax_meck $lower[7,])
exp(forecast_sarimax_meck $upper[7,])
exp(forecast_sarimax_meck $mean[7])-exp(cases_test_meck_seasonal[7])

exp(forecast_sarimax_meck $mean[14])
exp(forecast_sarimax_meck$lower[14,])
exp(forecast_sarimax_meck $upper[14,])
exp(forecast_sarimax_meck $mean[14]) -exp(cases_test_meck_seasonal[14])

#new hanover

vars_weather_hanover <- ts.union(viral_train_hanover_seasonal,precipation_hanover_train,
                 temp_hanover_train)

vars_test_weather_hanover <- ts.union(viral_test_hanover_seasonal,precipation_hanover_test,
                      temp_hanover_test)

wastewater_weather_mod_sarimax_hanover <- Arima(cases_train_hanover_seasonal,
                                       order = c(2,3,2),
                                       seasonal = list(order=c(1,1,2),period=7),
                                       xreg = vars_weather_hanover,method = "CSS") #rain is significant
coeftest(wastewater_weather_mod_sarimax_hanover)
forecast_sarimax_hanover <- forecast::forecast(wastewater_weather_mod_sarimax_hanover , h=14,
                                    xreg = vars_test_weather_hanover)
rmse(cases_test_hanover_seasonal,forecast_sarimax_hanover$mean) 
mae(cases_test_hanover_seasonal,forecast_sarimax_hanover$mean) 
checkresiduals(wastewater_weather_mod_sarimax_hanover)

exp(forecast_sarimax_hanover $mean[1])
exp(forecast_sarimax_hanover $lower[1,])
exp(forecast_sarimax_hanover $upper[1,])
exp(forecast_sarimax_hanover $mean[1])-exp(cases_test_hanover_seasonal[1])

exp(forecast_sarimax_hanover $mean[7])
exp(forecast_sarimax_hanover $lower[7,])
exp(forecast_sarimax_hanover $upper[7,])
exp(forecast_sarimax_hanover $mean[7])-exp(cases_test_hanover_seasonal[7])

exp(forecast_sarimax_hanover $mean[14])
exp(forecast_sarimax_hanover $lower[14,])
exp(forecast_sarimax_hanover $upper[14,])
exp(forecast_sarimax_hanover $mean[14]) -exp(cases_test_hanover_seasonal[14])
```

## Autoregressive Distributed Lag Model

```{r}
#wake

full_cases_wastewater_weather_data <- full_cases_wastewater_weather_data[-c(505,506,507),]

full_cases_wastewater_weather_data <- full_cases_wastewater_weather_data %>% 
  mutate(log_mean_new_cases = log(mean_new_cases),
         log_viral_gene = log(full_viral_gene_copies_per_person))

full_cases_wastewater_weather_data <- full_cases_wastewater_weather_data %>% 
  mutate(log_mean_new_cases = seasadj(decompose(ts(log_mean_new_cases, frequency=7))),
         log_viral_gene = seasadj(decompose(ts(log_viral_gene, frequency=7))))


full_cases_wastewater_weather_data_train <- 
  full_cases_wastewater_weather_data[-c(491:504),]
full_cases_wastewater_weather_data_test <- 
  full_cases_wastewater_weather_data[c(491:504),]

lowest_rmse <- Inf
best_mod <- NULL

for (p in seq(1,14)){
  for (q in seq(1,14)){
    mod <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                   data = full_cases_wastewater_weather_data_train, p=p,q=q)
    f <- forecast(mod, x= t(full_cases_wastewater_weather_data_test[,7]),h=14)
    forecast_acc <- rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
                         f$forecasts) #interchanged between RMSE and MAE 
    if (forecast_acc<lowest_rmse){
      lowest_rmse<- forecast_acc
      best_mod <-mod 
    }
  }
}

lowest_rmse #0.209
summary(best_mod) #ARDL(1,13)
checkresiduals(best_mod)

mod_ardl113 <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
               data = full_cases_wastewater_weather_data_train, p=13,q=1)
summary(mod_ardl113) 
f_ardl113  <- forecast(mod_ardl113, 
                       x= t(full_cases_wastewater_weather_data_test[,7]),
                       h=14)
rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_ardl113$forecasts)
mae(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_ardl113$forecasts)
checkresiduals(mod_ardl113)

mod_ardl1411 <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                       data = full_cases_wastewater_weather_data_train, 
                       p=11,q=14)
summary(mod_ardl1411) 
f_ardl1411  <- forecast(mod_ardl1411, 
                        x= t(full_cases_wastewater_weather_data_test[,7]),
                        h=14)
rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_ardl1411$forecasts)
mae(full_cases_wastewater_weather_data_test$log_mean_new_cases,
    f_ardl1411$forecasts)
checkresiduals(mod_ardl1411)

mod_ardl92 <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                        data = full_cases_wastewater_weather_data_train, 
                        p=2,q=9)
summary(mod_ardl92 ) 
f_ardl92 <- forecast(mod_ardl92  , 
                     x= t(full_cases_wastewater_weather_data_test[,7]),
                     h=14,
                     interval = TRUE)
rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_ardl92$forecasts[,2])
mae(full_cases_wastewater_weather_data_test$log_mean_new_cases,
    f_ardl92$forecasts[,2])
checkresiduals(mod_ardl92)

exp(f_ardl92$forecasts[1,2])
exp(f_ardl92$forecasts[1,1])
exp(f_ardl92$forecasts[1,3])
exp(f_ardl92$forecasts[1,2]) - exp(full_cases_wastewater_weather_data_test[1,6])

exp(f_ardl92$forecasts[7,2])
exp(f_ardl92$forecasts[7,1])
exp(f_ardl92$forecasts[7,3])
exp(f_ardl92$forecasts[7,2]) - exp(full_cases_wastewater_weather_data_test[7,6])

exp(f_ardl92$forecasts[14,2])
exp(f_ardl92$forecasts[14,1])
exp(f_ardl92$forecasts[14,3])
exp(f_ardl92$forecasts[14,2]) - exp(full_cases_wastewater_weather_data_test[14,6])

lowest_rmse_weather <- Inf
best_mod_weather <- NULL

for (p in seq(1,14)){
  for (q in seq(1,14)){
    remove <- list(p =list(TAVG=c(1:p),mean_precipation=c(1:p)))
    mod <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                     TAVG,data = full_cases_wastewater_weather_data_train,
                   p=p,q=q,
                   remove = remove)
    f <- forecast(mod, x= t(full_cases_wastewater_weather_data_test[,c(7,4,5)]),h=14)
    forecast_acc <- rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
                         f$forecasts) #interchanged between RMSE and MAE 
    if (forecast_acc<lowest_rmse_weather){
      lowest_rmse_weather <- forecast_acc
      best_mod_weather <- mod 
    }
  }
}

lowest_rmse_weather #0.20
summary(best_mod_weather) #ARDL(13,11)

remove <- list(p =list(TAVG=c(1:11),mean_precipation=c(1:11)))
mod_ardl1311_weather <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                 TAVG,data = full_cases_wastewater_weather_data_train, 
               p=11,q=13,
               remove = remove)
summary(mod_ardl1311_weather)
f_ardl1311_weather <- forecast(mod_ardl1311_weather, 
                               x= t(full_cases_wastewater_weather_data_test[,c(7,4,5)]),
                               h=14)
rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_ardl1311_weather$forecasts) 
mae(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_ardl1311_weather$forecasts) 
checkresiduals(mod_ardl1311_weather)

remove <- list(p =list(TAVG=c(1:13),mean_precipation=c(1:13)))
mod_ardl813_weather <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                                  TAVG,data = full_cases_wastewater_weather_data_train, 
                                p=13,q=8,
                                remove = remove)
summary(mod_ardl813_weather)
f_ardl813_weather <- forecast(mod_ardl813_weather, x= t(full_cases_wastewater_weather_data_test[,c(7,4,5)]),h=14)
rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_ardl813_weather$forecasts) 
mae(full_cases_wastewater_weather_data_test$log_mean_new_cases,
    f_ardl813_weather$forecasts) 
checkresiduals(mod_ardl813_weather)

remove <- list(p =list(TAVG=c(1:14),mean_precipation=c(1:14)))
mod_ardl914_weather <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                                 TAVG,data = full_cases_wastewater_weather_data_train, 
                               p=14,q=9,
                               remove = remove)
summary(mod_ardl914_weather)
f_ardl914_weather <- forecast(mod_ardl914_weather, x= t(full_cases_wastewater_weather_data_test[,c(7,4,5)]),h=14, interval = TRUE)
rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_ardl914_weather$forecasts[,2]) 
mae(full_cases_wastewater_weather_data_test$log_mean_new_cases,
    f_ardl914_weather$forecasts[,2]) 
checkresiduals(mod_ardl914_weather)

exp(f_ardl914_weather$forecasts[1,2])
exp(f_ardl914_weather$forecasts[1,1])
exp(f_ardl914_weather$forecasts[1,3])
exp(f_ardl914_weather$forecasts[1,2]) - exp(full_cases_wastewater_weather_data_test[1,6])

exp(f_ardl914_weather$forecasts[7,2])
exp(f_ardl914_weather$forecasts[7,1])
exp(f_ardl914_weather$forecasts[7,3])
exp(f_ardl914_weather$forecasts[7,2]) - exp(full_cases_wastewater_weather_data_test[7,6])

exp(f_ardl914_weather$forecasts[14,2])
exp(f_ardl914_weather$forecasts[14,1])
exp(f_ardl914_weather$forecasts[14,3])
exp(f_ardl914_weather$forecasts[14,2]) - exp(full_cases_wastewater_weather_data_test[14,6])

#Mecklenburg

full_cases_wastewater_weather_data_meck <- full_cases_wastewater_weather_data_meck[-c(505,506,507),]

full_cases_wastewater_weather_data_meck <- full_cases_wastewater_weather_data_meck %>% 
  mutate(log_mean_new_cases = log(mean_new_cases),
         log_viral_gene = log(full_viral_gene_copies_per_person))

full_cases_wastewater_weather_data_meck <- full_cases_wastewater_weather_data_meck %>% 
  mutate(log_mean_new_cases = seasadj(decompose(ts(log_mean_new_cases, frequency=7))),
         log_viral_gene = seasadj(decompose(ts(log_viral_gene, frequency=7))))


full_cases_wastewater_weather_data_meck_train <- 
  full_cases_wastewater_weather_data_meck[-c(491:504),]
full_cases_wastewater_weather_data_meck_test <- 
  full_cases_wastewater_weather_data_meck[c(491:504),]

lowest_rmse_meck <- Inf
best_mod_meck <- NULL

for (p in seq(1,14)){
  for (q in seq(1,14)){
    mod <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                   data = full_cases_wastewater_weather_data_meck_train, p=p,q=q)
    f <- forecast(mod, x= t(full_cases_wastewater_weather_data_meck_test[,8]),h=14)
    forecast_acc <- rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
                         f$forecasts) #interchanged between RMSE and MAE 
    if (forecast_acc<lowest_rmse_meck){
      lowest_rmse_meck<- forecast_acc
      best_mod_meck <-mod 
    }
  }
}

lowest_rmse_meck #0.11
summary(best_mod_meck) #ARDL(5,1)

mod_ardl51_meck <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
               data = full_cases_wastewater_weather_data_meck_train, p=1,q=5)
summary(mod_ardl51_meck) #wastewater is significant at lagged time t-1
f_ardl51_meck <- forecast(mod_ardl51_meck , x= t(full_cases_wastewater_weather_data_meck_test[,8]),h=14)
rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
                     f_ardl51_meck$forecasts)
mae(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
    f_ardl51_meck$forecasts)
checkresiduals(mod_ardl51_meck)


mod_ardl84_meck <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                      data = full_cases_wastewater_weather_data_meck_train,
                      p=4,q=8)
summary(mod_ardl84_meck)
f_ardl84_meck <- forecast(mod_ardl84_meck , 
                          x= t(full_cases_wastewater_weather_data_meck_test[,8]),
                          h=14)
rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_ardl84_meck$forecasts)
mae(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
    f_ardl84_meck$forecasts)
checkresiduals(mod_ardl84_meck)

mod_ardl113_meck <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                           data = full_cases_wastewater_weather_data_meck_train, 
                           p=13,q=1)
f_ardl113_meck <- forecast(mod_ardl113_meck , 
                           x= t(full_cases_wastewater_weather_data_meck_test[,8]),
                           h=14)
rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_ardl113_meck$forecasts)
mae(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
    f_ardl113_meck$forecasts)
checkresiduals(mod_ardl113_meck)

mod_ardl92_meck <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                            data = full_cases_wastewater_weather_data_meck_train, 
                            p=2,q=9)
summary(mod_ardl92_meck)
f_ardl92_meck <- forecast(mod_ardl92_meck , 
                          x= t(full_cases_wastewater_weather_data_meck_test[,8]),
                          h=14, interval = TRUE)
rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_ardl92_meck$forecasts[,2])
mae(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
    f_ardl92_meck$forecasts[,2])
checkresiduals(mod_ardl92_meck)

exp(f_ardl92_meck $forecasts[1,2])
exp(f_ardl92_meck $forecasts[1,1])
exp(f_ardl92_meck $forecasts[1,3])
exp(f_ardl92_meck $forecasts[1,2]) - exp(full_cases_wastewater_weather_data_meck_test[1,7])

exp(f_ardl92_meck $forecasts[7,2])
exp(f_ardl92_meck $forecasts[7,1])
exp(f_ardl92_meck $forecasts[7,3])
exp(f_ardl92_meck $forecasts[7,2]) - exp(full_cases_wastewater_weather_data_meck_test[7,7])

exp(f_ardl92_meck $forecasts[14,2])
exp(f_ardl92_meck $forecasts[14,1])
exp(f_ardl92_meck $forecasts[14,3])
exp(f_ardl92_meck $forecasts[14,2]) - exp(full_cases_wastewater_weather_data_meck_test[14,7])

lowest_rmse_weather_meck <- Inf
best_mod_weather_meck <- NULL

for (p in seq(1,14)){
  for (q in seq(1,14)){
    remove = list(p =list(TAVG=c(1:p),mean_precipation=c(1:p)))
    mod <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                     TAVG,data = full_cases_wastewater_weather_data_meck_train, 
                   p=p,q=q,
                   remove = remove)
    f <- forecast(mod, x= t(full_cases_wastewater_weather_data_meck_test[,c(8,5,6)]),h=14)
    forecast_acc <- rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
                         f$forecasts) #interchanged between RMSE and MAE 
    if (forecast_acc<lowest_rmse_weather_meck){
      lowest_rmse_weather_meck <- forecast_acc
      best_mod_weather_meck <- mod 
    }
  }
}

lowest_rmse_weather_meck #0.118
summary(best_mod_weather_meck) #ARDL(8,13)(lowest RMSE), ARDL(8,14)(lowest MAE)

remove <- list(p =list(TAVG=c(1:13),mean_precipation=c(1:13)))
mod_ardl813_weather_meck <- ardlDlm(log_mean_new_cases ~ log_viral_gene + 
                                      mean_precipation +
                                      TAVG,
                                    data = full_cases_wastewater_weather_data_meck_train,
                                    p=13,q=8,
                                    remove = remove)
f_ardl813_weather_meck <- forecast(mod_ardl813_weather_meck, 
                                   x= t(full_cases_wastewater_weather_data_meck_test[,c(8,5,6)]),
                                   h=14)
rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_ardl813_weather_meck$forecasts) 
mae(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_ardl813_weather_meck$forecasts) 
checkresiduals(mod_ardl813_weather_meck)

remove <- list(p =list(TAVG=c(1:14),mean_precipation=c(1:14)))
mod_ardl814_weather_meck <- ardlDlm(log_mean_new_cases ~ log_viral_gene + 
                                      mean_precipation +
                                      TAVG,
                                    data = full_cases_wastewater_weather_data_meck_train, 
                                    p=14,q=8,
                                    remove = remove)
f_ardl814_weather_meck <- forecast(mod_ardl814_weather_meck, 
                                   x= t(full_cases_wastewater_weather_data_meck_test[,c(8,5,6)]),
                                   h=14)
rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_ardl814_weather_meck$forecasts) 
mae(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
    f_ardl814_weather_meck$forecasts) 
checkresiduals(mod_ardl814_weather_meck)

remove <- list(p =list(TAVG=c(1:11),mean_precipation=c(1:11)))
mod_ardl1311_weather_meck <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                                      TAVG,data = full_cases_wastewater_weather_data_meck_train, 
                                    p=11,q=13,
                                    remove = remove)
f_ardl1311_weather_meck <- forecast(mod_ardl1311_weather_meck, x= t(full_cases_wastewater_weather_data_meck_test[,c(8,5,6)]),h=14)
rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_ardl1311_weather_meck$forecasts)
mae(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
    f_ardl1311_weather_meck$forecasts) 
checkresiduals(mod_ardl1311_weather_meck)

remove <- list(p =list(TAVG=c(1:14),mean_precipation=c(1:14)))
mod_ardl914_weather_meck <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                                       TAVG,data = full_cases_wastewater_weather_data_meck_train, 
                                     p=14,q=9,
                                     remove = remove)

remove <- list(p =list(TAVG=c(1:14),mean_precipation=c(1:14)))
mod_ardl914_weather_meck <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                                       TAVG,data = full_cases_wastewater_weather_data_meck_train, 
                                     p=14,q=9,
                                     remove = remove)
summary(mod_ardl914_weather_meck)
f_ardl914_weather_meck <- forecast(mod_ardl914_weather_meck, 
                                   x= t(full_cases_wastewater_weather_data_meck_test[,c(8,5,6)]),
                                   h=14,
                                   interval = TRUE)
rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_ardl914_weather_meck$forecasts[,2]) 
mae(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
    f_ardl914_weather_meck$forecasts[,2]) 
checkresiduals(mod_ardl914_weather_meck)

exp(f_ardl914_weather_meck$forecasts[1,2])
exp(f_ardl914_weather_meck$forecasts[1,1])
exp(f_ardl914_weather_meck$forecasts[1,3])
exp(f_ardl914_weather_meck$forecasts[1,2]) - exp(full_cases_wastewater_weather_data_meck_test[1,7])

exp(f_ardl914_weather_meck$forecasts[7,2])
exp(f_ardl914_weather_meck$forecasts[7,1])
exp(f_ardl914_weather_meck$forecasts[7,3])
exp(f_ardl914_weather_meck$forecasts[7,2]) - exp(full_cases_wastewater_weather_data_meck_test[7,7])

exp(f_ardl914_weather_meck$forecasts[14,2])
exp(f_ardl914_weather_meck$forecasts[14,1])
exp(f_ardl914_weather_meck$forecasts[14,3])
exp(f_ardl914_weather_meck$forecasts[14,2]) - exp(full_cases_wastewater_weather_data_meck_test[14,7])


#New Hanover

full_cases_wastewater_weather_data_hanover <- 
  full_cases_wastewater_weather_data_hanover[-c(505,506,507),]

full_cases_wastewater_weather_data_hanover <- full_cases_wastewater_weather_data_hanover %>% 
  mutate(log_mean_new_cases = log(mean_new_cases),
         log_viral_gene = log(full_viral_gene_copies_per_person))

full_cases_wastewater_weather_data_hanover <- full_cases_wastewater_weather_data_hanover %>% 
  mutate(log_mean_new_cases = seasadj(decompose(ts(log_mean_new_cases, frequency=7))),
         log_viral_gene = seasadj(decompose(ts(log_viral_gene, frequency=7))))

full_cases_wastewater_weather_data_hanover_train <- 
  full_cases_wastewater_weather_data_hanover[-c(491:504),]
full_cases_wastewater_weather_data_hanover_test <- 
  full_cases_wastewater_weather_data_hanover[c(491:504),]

lowest_rmse_hanover <- Inf
best_mod_hanover <- NULL

for (p in seq(1,14)){
  for (q in seq(1,14)){
    mod <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                   data = full_cases_wastewater_weather_data_hanover_train, p=p,q=q)
    f <- forecast(mod, x= t(full_cases_wastewater_weather_data_hanover_test[,7]),h=14)
    forecast_acc <- rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
                         f$forecasts) #interchanged between RMSE and MAE 
    if (forecast_acc<lowest_rmse_hanover){
      lowest_rmse_hanover<- forecast_acc
      best_mod_hanover <-mod 
    }
  }
}

lowest_rmse_hanover #0.348 (0.317)
summary(best_mod_hanover) 
tsdisplay(residuals(best_mod_hanover))

mod_ardl92_hanover <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
               data = full_cases_wastewater_weather_data_hanover_train, 
               p=2,q=9)
summary(mod_ardl92_hanover)
f_ardl92_hanover  <- forecast(mod_ardl92_hanover, 
                              x= t(full_cases_wastewater_weather_data_hanover_test[,7]),
                              h=14,
                              interval = TRUE)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
     f_ardl92_hanover$forecasts[,2])
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
    f_ardl92_hanover$forecasts[,2])
checkresiduals(mod_ardl92_hanover)

exp(f_ardl92_hanover $forecasts[1,2])
exp(f_ardl92_hanover $forecasts[1,1])
exp(f_ardl92_hanover $forecasts[1,3])
exp(f_ardl92_hanover $forecasts[1,2]) - exp(full_cases_wastewater_weather_data_hanover_test[1,6])

exp(f_ardl92_hanover$forecasts[7,2])
exp(f_ardl92_hanover$forecasts[7,1])
exp(f_ardl92_hanover$forecasts[7,3])
exp(f_ardl92_hanover$forecasts[7,2]) - exp(full_cases_wastewater_weather_data_hanover_test[7,6])

exp(f_ardl92_hanover$forecasts[14,2])
exp(f_ardl92_hanover$forecasts[14,1])
exp(f_ardl92_hanover$forecasts[14,3])
exp(f_ardl92_hanover$forecasts[14,2]) - exp(full_cases_wastewater_weather_data_hanover_test[14,6])


mod_ardl144_hanover <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                              data = full_cases_wastewater_weather_data_hanover_train, 
                              p=4,q=14)
summary(mod_ardl144_hanover) #wastewater is significant at current time t
f_ardl144_hanover  <- forecast(mod_ardl144_hanover, 
                               x= t(full_cases_wastewater_weather_data_hanover_test[,7]),
                               h=14)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
     f_ardl144_hanover$forecasts)
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
    f_ardl144_hanover$forecasts)
checkresiduals(mod_ardl144_hanover)


mod_ardl113_hanover <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                              data = full_cases_wastewater_weather_data_hanover_train, 
                              p=13,q=1)
f_ardl113_hanover  <- forecast(mod_ardl113_hanover, x= t(full_cases_wastewater_weather_data_hanover_test[,7]),h=14)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
     f_ardl113_hanover$forecasts)
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
    f_ardl113_hanover$forecasts)
checkresiduals(mod_ardl113_hanover)

mod_ardl51_hanover <- ardlDlm(log_mean_new_cases ~ log_viral_gene,
                               data = full_cases_wastewater_weather_data_hanover_train, 
                               p=1,q=5)
f_ardl51_hanover  <- forecast(mod_ardl51_hanover, x= t(full_cases_wastewater_weather_data_hanover_test[,7]),h=14)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
     f_ardl51_hanover$forecasts)
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
    f_ardl51_hanover$forecasts)
checkresiduals(mod_ardl51_hanover)

lowest_rmse_weather_hanover <- Inf
best_mod_weather_hanover <- NULL

for (p in seq(1,14)){
  for (q in seq(1,14)){
    remove <- list(p =list(mean_precipation = c(1:p),
                           mean_temp= c(1:p)))
    mod <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                     mean_temp,data = full_cases_wastewater_weather_data_hanover_train, 
                   p=p,q=q,
                   remove = remove)
    f <- forecast(mod, 
                  x= t(full_cases_wastewater_weather_data_hanover_test[,c(7,4,5)]),
                  h=14)
    forecast_acc <- rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases, 
                         f$forecasts) #interchanged between RMSE and MAE
    if (forecast_acc<lowest_rmse_weather_hanover){
      lowest_rmse_weather_hanover <- forecast_acc
      best_mod_weather_hanover <- mod 
    }
  }
}

lowest_rmse_weather_hanover #0.35
summary(best_mod_weather_hanover) #ARDL(9,14) (lowest RMSE), ARDL(14,14) (lowest MAE)

remove <- list(p =list(mean_precipation = c(1:14),
                       mean_temp= c(1:14)))
mod_ardl914_weather_hanover <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                 mean_temp,data = full_cases_wastewater_weather_data_hanover_train, 
               p=14,q=9,
               remove = remove)
summary(mod_ardl914_weather_hanover)
f_ardl914_weather_hanover <- forecast(mod_ardl914_weather_hanover, 
                                      x= t(full_cases_wastewater_weather_data_hanover_test[,c(7,4,5)]),
                                      h=14, interval = TRUE)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases, 
     f_ardl914_weather_hanover$forecasts) 
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases, 
     f_ardl914_weather_hanover$forecasts) 
checkresiduals(mod_ardl914_weather_hanover)

exp(f_ardl914_weather_hanover$forecasts[1,2])
exp(f_ardl914_weather_hanover$forecasts[1,1])
exp(f_ardl914_weather_hanover$forecasts[1,3])
exp(f_ardl914_weather_hanover$forecasts[1,2]) - exp(full_cases_wastewater_weather_data_hanover_test[1,6])

exp(f_ardl914_weather_hanover$forecasts[7,2])
exp(f_ardl914_weather_hanover$forecasts[7,1])
exp(f_ardl914_weather_hanover$forecasts[7,3])
exp(f_ardl914_weather_hanover$forecasts[7,2]) - exp(full_cases_wastewater_weather_data_hanover_test[7,6])

exp(f_ardl914_weather_hanover$forecasts[14,2])
exp(f_ardl914_weather_hanover$forecasts[14,1])
exp(f_ardl914_weather_hanover$forecasts[14,3])
exp(f_ardl914_weather_hanover$forecasts[14,2]) - exp(full_cases_wastewater_weather_data_hanover_test[14,6])


remove <- list(p =list(mean_precipation = c(1:14),
                       mean_temp= c(1:14)))
mod_ardl1414_weather_hanover <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                                         mean_temp,data = full_cases_wastewater_weather_data_hanover_train, 
                                       p=14,q=14,
                                       remove = remove)
summary(mod_ardl1414_weather_hanover)
f_ardl1414_weather_hanover <- forecast(mod_ardl1414_weather_hanover, x= t(full_cases_wastewater_weather_data_hanover_test[,c(7,4,5)]),h=14)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases, 
     f_ardl1414_weather_hanover$forecasts) 
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases, 
    f_ardl1414_weather_hanover$forecasts) 
checkresiduals(mod_ardl1414_weather_hanover)

remove <- list(p =list(mean_precipation = c(1:11),
                       mean_temp= c(1:11)))
mod_ardl1311_weather_hanover <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                                          mean_temp,data = full_cases_wastewater_weather_data_hanover_train, 
                                        p=11,q=13,
                                        remove = remove)
summary(mod_ardl1311_weather_hanover)
f_ardl1311_weather_hanover <- forecast(mod_ardl1311_weather_hanover, x= t(full_cases_wastewater_weather_data_hanover_test[,c(7,4,5)]),h=14)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases, 
     f_ardl1311_weather_hanover$forecasts) 
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases, 
    f_ardl1311_weather_hanover$forecasts)
checkresiduals(mod_ardl1311_weather_hanover)

remove <- list(p =list(mean_precipation = c(1:13),
                       mean_temp= c(1:13)))
mod_ardl813_weather_hanover <- ardlDlm(log_mean_new_cases ~ log_viral_gene + mean_precipation +
                                          mean_temp,data = full_cases_wastewater_weather_data_hanover_train, 
                                        p=13,q=8,
                                        remove = remove)
summary(mod_ardl813_weather_hanover)
f_ardl813_weather_hanover <- forecast(mod_ardl813_weather_hanover, x= t(full_cases_wastewater_weather_data_hanover_test[,c(7,4,5)]),h=14)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases, 
     f_ardl813_weather_hanover$forecasts) 
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases, 
    f_ardl813_weather_hanover$forecasts) 
checkresiduals(mod_ardl813_weather_hanover)

#plots#

mod_ardl92_acf <- ggAcf(residuals(mod_ardl92)) + theme_bw() 
mod_ardl92_meck_acf <- ggAcf(residuals(mod_ardl92_meck)) + theme_bw()
mod_ardl92_hanover_acf <- ggAcf(residuals(mod_ardl92_hanover)) + theme_bw()
  

png(filename="ardl_92_forecast_acf.png", units="cm", res = 700,
    width = 20,height = 15)
grid.arrange(mod_ardl92_acf,
             mod_ardl92_meck_acf,
             mod_ardl92_hanover_acf)
dev.off()

#ARDL forecasting plots

full_cases_wastewater_weather_data_test <-
  cbind(full_cases_wastewater_weather_data_test,f_ardl92$forecasts[,2],
        f_ardl92$forecasts[,1],f_ardl92$forecasts[,3],
        f_ardl914_weather$forecasts[,2],f_ardl914_weather$forecasts[,1],
        f_ardl914_weather$forecasts[,3])

full_cases_wastewater_weather_data_meck_test <-
  cbind(full_cases_wastewater_weather_data_meck_test,f_ardl92_meck$forecasts[,2],
        f_ardl92_meck$forecasts[,1],f_ardl92_meck$forecasts[,3],
        f_ardl914_weather_meck$forecasts[,2],f_ardl914_weather_meck$forecasts[,1],
        f_ardl914_weather_meck$forecasts[,3])

full_cases_wastewater_weather_data_hanover_test <-
  cbind(full_cases_wastewater_weather_data_hanover_test,f_ardl92_hanover$forecasts[,2],
        f_ardl92_hanover$forecasts[,1],f_ardl92_hanover$forecasts[,3],
        f_ardl914_weather_hanover$forecasts[,2],f_ardl914_weather_hanover$forecasts[,1],
        f_ardl914_weather_hanover$forecasts[,3])

wake_ardl_noweather_plot <-
  full_cases_wastewater_weather_data_train %>% 
  ggplot(aes(Date,log_mean_new_cases)) + 
  geom_line() + 
  geom_ribbon(data = full_cases_wastewater_weather_data_test, aes(ymin = f_ardl92$forecasts[,1], ymax = f_ardl92$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) +
  geom_line(data = full_cases_wastewater_weather_data_test,aes(Date,log_mean_new_cases,color="Actual")) +
  geom_line(data = full_cases_wastewater_weather_data_test,aes(Date,f_ardl92$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "none") + ylab("")

meck_ardl_noweather_plot <- full_cases_wastewater_weather_data_meck_train %>% 
  ggplot(aes(Date,log_mean_new_cases)) + 
  geom_line() + 
  geom_ribbon(data = full_cases_wastewater_weather_data_meck_test, aes(ymin = f_ardl92_meck$forecasts[,1], ymax = f_ardl92_meck$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) +
  geom_line(data = full_cases_wastewater_weather_data_meck_test,aes(Date,log_mean_new_cases,color="Actual")) +
  geom_line(data = full_cases_wastewater_weather_data_meck_test,aes(Date,f_ardl92_meck$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "none") + ylab("")

hanover_ardl_noweather_plot <- full_cases_wastewater_weather_data_hanover_train %>% 
  ggplot(aes(Date,log_mean_new_cases)) + 
  geom_line() + 
  geom_ribbon(data = full_cases_wastewater_weather_data_hanover_test, aes(ymin = f_ardl92_hanover$forecasts[,1], ymax = f_ardl92_hanover$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) +
  geom_line(data = full_cases_wastewater_weather_data_hanover_test,aes(Date,log_mean_new_cases,color="Actual")) +
  geom_line(data = full_cases_wastewater_weather_data_hanover_test,aes(Date,f_ardl92_hanover$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "bottom") + ylab("")

wake_ardl_weather_plot <-
  full_cases_wastewater_weather_data_train %>% 
  ggplot(aes(Date,log_mean_new_cases)) + 
  geom_line() + 
  geom_ribbon(data = full_cases_wastewater_weather_data_test, aes(ymin = f_ardl914_weather$forecasts[,1], ymax = f_ardl914_weather$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) +
  geom_line(data = full_cases_wastewater_weather_data_test,aes(Date,log_mean_new_cases,color="Actual")) +
  geom_line(data = full_cases_wastewater_weather_data_test,aes(Date,f_ardl914_weather$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "none") + ylab("")

meck_ardl_weather_plot <- full_cases_wastewater_weather_data_meck_train %>% 
  ggplot(aes(Date,log_mean_new_cases)) + 
  geom_line() + 
  geom_ribbon(data = full_cases_wastewater_weather_data_meck_test, aes(ymin = f_ardl914_weather_meck$forecasts[,1], ymax = f_ardl914_weather_meck$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) +
  geom_line(data = full_cases_wastewater_weather_data_meck_test,aes(Date,log_mean_new_cases,color="Actual")) +
  geom_line(data = full_cases_wastewater_weather_data_meck_test,aes(Date,f_ardl914_weather_meck$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "none") + ylab("")

hanover_ardl_weather_plot <- full_cases_wastewater_weather_data_hanover_train %>% 
  ggplot(aes(Date,log_mean_new_cases)) + 
  geom_line() + 
  geom_ribbon(data = full_cases_wastewater_weather_data_hanover_test, aes(ymin = f_ardl914_weather_hanover$forecasts[,1], ymax = f_ardl914_weather_hanover$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) +
  geom_line(data = full_cases_wastewater_weather_data_hanover_test,aes(Date,log_mean_new_cases,color="Actual")) +
  geom_line(data = full_cases_wastewater_weather_data_hanover_test,aes(Date,f_ardl914_weather_hanover$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "bottom") + ylab("")

png(filename = "ardl_plots.png", res = 700, units = "cm",
    width = 20, height = 15)
grid.arrange(wake_ardl_noweather_plot,
             wake_ardl_weather_plot,
             meck_ardl_noweather_plot,
             meck_ardl_weather_plot,
             hanover_ardl_noweather_plot,
             hanover_ardl_weather_plot,
             ncol=2,
             left = text_grob("Logarithm of New COVID-19 cases per 10K", rot = 90, vjust = 1))
dev.off()


```

## Distributed Lag Model

```{r}
#wastewater only#
#wake

lowest_rmse_dl_wake <- Inf
best_mod_dl_wake <- NULL

for (q in seq(1,6)){
  mod <- dlm(log_mean_new_cases ~ log_viral_gene,
             data = full_cases_wastewater_weather_data_train,q=q)
  f <- forecast(mod, x= t(full_cases_wastewater_weather_data_test[,7]),h=14,
                interval = TRUE)
  forecast_acc <- rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
                       f$forecasts[,2]) #interchanged between RMSE and MAE
  if (forecast_acc<lowest_rmse_dl_wake){
    lowest_rmse_dl_wake<- forecast_acc
    best_mod_dl_wake <-mod 
  }
}


lowest_rmse_dl_wake 
summary(best_mod_dl_wake) #DL(13) (lowest RMSE), DL(14) (lowest MAE)

mod_dl13 <- dlm(log_mean_new_cases ~ log_viral_gene,
           data = full_cases_wastewater_weather_data_train,q=13)
f_dl13  <- forecast(mod_dl13, x= t(full_cases_wastewater_weather_data_test[,7]),h=14)
rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
    f_dl13$forecasts) 
mae(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_dl13$forecasts)
checkresiduals(mod_dl13)

mod_dl14 <- dlm(log_mean_new_cases ~ log_viral_gene,
           data = full_cases_wastewater_weather_data_train,q=14)
summary(mod_dl14)
f_dl14 <- forecast(mod_dl14, x= t(full_cases_wastewater_weather_data_test[,7]),
                  h=14, interval = TRUE)
rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_dl14$forecasts[,2]) 
mae(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_dl14$forecasts[,2]) 
checkresiduals(mod_dl14)

exp(f_dl14$forecasts[1,2])
exp(f_dl14$forecasts[1,1])
exp(f_dl14$forecasts[1,3])
exp(f_dl14$forecasts[1,2]) - exp(full_cases_wastewater_weather_data_test[1,6])

exp(f_dl14$forecasts[7,2])
exp(f_dl14$forecasts[7,1])
exp(f_dl14$forecasts[7,3])
exp(f_dl14$forecasts[7,2]) - exp(full_cases_wastewater_weather_data_test[7,6])

exp(f_dl14$forecasts[14,2])
exp(f_dl14$forecasts[14,1])
exp(f_dl14$forecasts[14,3])
exp(f_dl14$forecasts[14,2]) - exp(full_cases_wastewater_weather_data_test[14,6])

mod_dl2 <- dlm(log_mean_new_cases ~ log_viral_gene,
               data = full_cases_wastewater_weather_data_train,q=2)
summary(mod_dl2)
f_dl2 <- forecast(mod_dl2, x= t(full_cases_wastewater_weather_data_test[,7]),
                  h=14)
rmse(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_dl2$forecasts) 
mae(full_cases_wastewater_weather_data_test$log_mean_new_cases,
     f_dl2$forecasts) 
tsdisplay(residuals(mod_dl2))

#mecklenburg

lowest_rmse_dl_meck <- Inf
best_mod_dl_meck <- NULL

for (q in seq(1,14)){
  mod <- dlm(log_mean_new_cases ~ log_viral_gene,
             data = full_cases_wastewater_weather_data_meck_train,q=q)
  f <- forecast(mod, x= t(full_cases_wastewater_weather_data_meck_test[,8]),h=14,
                interval = TRUE)
  forecast_acc <- rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
                       f$forecasts[,2])
  if (forecast_acc<lowest_rmse_dl_meck){
    lowest_rmse_dl_meck<- forecast_acc
    best_mod_dl_meck <-mod 
  }
}


lowest_rmse_dl_meck #0.212, 0.149
summary(best_mod_dl_meck) #DL(2)
checkresiduals(best_mod_dl_meck)


mod_dl13_meck <- dlm(log_mean_new_cases ~ log_viral_gene,
               data = full_cases_wastewater_weather_data_meck_train,q=13)
summary(mod_dl13_meck)
f_dl13_meck <- forecast(mod_dl13_meck, 
                       x= t(full_cases_wastewater_weather_data_meck_test[,8]),
                       h=14)
rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_dl13_meck$forecasts) 
mae(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_dl13_meck$forecasts)
checkresiduals(mod_dl13_meck)

mod_dl14_meck <- dlm(log_mean_new_cases ~ log_viral_gene,
                     data = full_cases_wastewater_weather_data_meck_train,q=14)
summary(mod_dl14_meck)
f_dl14_meck <- forecast(mod_dl14_meck, 
                        x= t(full_cases_wastewater_weather_data_meck_test[,8]),
                        h=14,interval = TRUE)
rmse(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
     f_dl14_meck$forecasts[,2]) 
mae(full_cases_wastewater_weather_data_meck_test$log_mean_new_cases,
    f_dl14_meck$forecasts[,2]) 
checkresiduals(mod_dl14_meck)

exp(f_dl14_meck$forecasts[1,2])
exp(f_dl14_meck$forecasts[1,1])
exp(f_dl14_meck$forecasts[1,3])
exp(f_dl14_meck$forecasts[1,2]) - exp(full_cases_wastewater_weather_data_meck_test[1,7])

exp(f_dl14_meck$forecasts[7,2])
exp(f_dl14_meck$forecasts[7,1])
exp(f_dl14_meck$forecasts[7,3])
exp(f_dl14_meck$forecasts[7,2]) - exp(full_cases_wastewater_weather_data_meck_test[7,7])

exp(f_dl14_meck$forecasts[14,2])
exp(f_dl14_meck$forecasts[14,1])
exp(f_dl14_meck$forecasts[14,3])
exp(f_dl14_meck$forecasts[14,2]) - exp(full_cases_wastewater_weather_data_meck_test[14,7])


#New Hanover

lowest_rmse_dl_hanover <- Inf
best_mod_dl_hanover <- NULL

for (q in seq(1,14)){
  mod <- dlm(log_mean_new_cases ~ log_viral_gene,
             data = full_cases_wastewater_weather_data_hanover_train,q=q)
  f <- forecast(mod, x= t(full_cases_wastewater_weather_data_hanover_test[,7]),h=14)
  forecast_acc <- mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
                       f$forecasts)
  if (forecast_acc<lowest_rmse_dl_hanover){
    lowest_rmse_dl_hanover<- forecast_acc
    best_mod_dl_hanover <-mod 
  }
}


lowest_rmse_dl_hanover #0.581,0.449
summary(best_mod_dl_hanover) #DL(14)
tsdisplay(residuals(best_mod_dl_hanover))

mod_dl14_hanover <- dlm(log_mean_new_cases ~ log_viral_gene,
           data = full_cases_wastewater_weather_data_hanover_train,q=14)
summary(mod_dl14_hanover)
f_dl14_hanover <- forecast(mod_dl14_hanover,
                          x= t(full_cases_wastewater_weather_data_hanover_test[,7]),
                          h=14,interval = TRUE)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
    f_dl14_hanover$forecasts[,2])
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
     f_dl14_hanover$forecasts[,2])
checkresiduals(mod_dl14_hanover)

exp(f_dl14_hanover$forecasts[1,2])
exp(f_dl14_hanover$forecasts[1,1])
exp(f_dl14_hanover$forecasts[1,3])
exp(f_dl14_hanover$forecasts[1,2]) - exp(full_cases_wastewater_weather_data_hanover_test[1,6])

exp(f_dl14_hanover$forecasts[7,2])
exp(f_dl14_hanover$forecasts[7,1])
exp(f_dl14_hanover$forecasts[7,3])
exp(f_dl14_hanover$forecasts[7,2]) - exp(full_cases_wastewater_weather_data_hanover_test[7,6])

exp(f_dl14_hanover$forecasts[14,2])
exp(f_dl14_hanover$forecasts[14,1])
exp(f_dl14_hanover$forecasts[14,3])
exp(f_dl14_hanover$forecasts[14,2]) - exp(full_cases_wastewater_weather_data_hanover_test[14,6])


mod_dl2_hanover <- dlm(log_mean_new_cases ~ log_viral_gene,
                       data = full_cases_wastewater_weather_data_hanover_train,
                       q=2)
summary(mod_dl2_hanover)
f_dl2_hanover <- forecast(mod_dl2_hanover,
                          x= t(full_cases_wastewater_weather_data_hanover_test[,7]),
                          h=14)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
    f_dl2_hanover$forecasts) 
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
     f_dl2_hanover$forecasts) 
checkresiduals(mod_dl2_hanover)

mod_dl13_hanover <- dlm(log_mean_new_cases ~ log_viral_gene,
                       data = full_cases_wastewater_weather_data_hanover_train,
                       q=13)
summary(mod_dl13_hanover)
f_dl13_hanover <- forecast(mod_dl13_hanover,
                          x= t(full_cases_wastewater_weather_data_hanover_test[,7]),
                          h=14)
rmse(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
     f_dl13_hanover$forecasts) 
mae(full_cases_wastewater_weather_data_hanover_test$log_mean_new_cases,
    f_dl13_hanover$forecasts) 
checkresiduals(mod_dl13_hanover)

wake_mod_dl14_res <- ggAcf(residuals(mod_dl14)) + 
  theme_bw(base_size = 15) + ggtitle("")

meck_mod_dl14_res <- ggAcf(residuals(mod_dl14_meck)) + 
  theme_bw(base_size = 15) + ggtitle("")

hanover_mod_dl14_res <- ggAcf(residuals(mod_dl14_hanover)) + 
  theme_bw(base_size = 15) + ggtitle("")

png(filename = "DL_res.png", units = "cm", res = 700, 
    width = 20, height = 15)
grid.arrange(wake_mod_dl14_res,
             meck_mod_dl14_res,
             hanover_mod_dl14_res)
dev.off()

#DL forecasting plots#

full_cases_wastewater_weather_data_test <-
  cbind(full_cases_wastewater_weather_data_test,f_dl14$forecasts[,2],
        f_dl14$forecasts[,1],f_dl14$forecasts[,3])

full_cases_wastewater_weather_data_meck_test <-
  cbind(full_cases_wastewater_weather_data_meck_test,f_dl14_meck$forecasts[,2],
        f_dl14_meck$forecasts[,1],f_dl14_meck$forecasts[,3])

full_cases_wastewater_weather_data_hanover_test <-
  cbind(full_cases_wastewater_weather_data_hanover_test,f_dl14_hanover$forecasts[,2],
        f_dl14_hanover$forecasts[,1],f_dl14_hanover$forecasts[,3])


wake_dl_plot <- full_cases_wastewater_weather_data_train %>% 
  ggplot(aes(Date,log_mean_new_cases)) + 
  geom_line() + 
  geom_ribbon(data = full_cases_wastewater_weather_data_test, aes(ymin = f_dl14$forecasts[,1], ymax = f_dl14$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) +
  geom_line(data = full_cases_wastewater_weather_data_test,aes(Date,log_mean_new_cases,color="Actual")) +
  geom_line(data = full_cases_wastewater_weather_data_test,aes(Date,f_dl14$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "none") + ylab("")

meck_dl_plot <- full_cases_wastewater_weather_data_meck_train %>% 
  ggplot(aes(Date,log_mean_new_cases)) + 
  geom_line() + 
  geom_ribbon(data = full_cases_wastewater_weather_data_meck_test, aes(ymin = f_dl14_meck$forecasts[,1], ymax = f_dl14_meck$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) +
  geom_line(data = full_cases_wastewater_weather_data_meck_test,aes(Date,log_mean_new_cases,color="Actual")) +
  geom_line(data = full_cases_wastewater_weather_data_meck_test,aes(Date,f_dl14_meck$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "none") + ylab("")

hanover_dl_plot <- full_cases_wastewater_weather_data_hanover_train %>% 
  ggplot(aes(Date,log_mean_new_cases)) + 
  geom_line() + 
  geom_ribbon(data = full_cases_wastewater_weather_data_hanover_test, aes(ymin = f_dl14_hanover$forecasts[,1], ymax = f_dl14_hanover$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) +
  geom_line(data = full_cases_wastewater_weather_data_hanover_test,aes(Date,log_mean_new_cases,color="Actual")) +
  geom_line(data = full_cases_wastewater_weather_data_hanover_test,aes(Date,f_dl14_hanover$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "bottom") + ylab("")

png(filename = "dl_plots.png",res = 700, units = "cm",
    width = 20,height = 15)
grid.arrange(wake_dl_plot,
             meck_dl_plot,
             hanover_dl_plot,
             ncol=1,
             left = text_grob("Logarithm of New COVID-19 cases per 10K", rot = 90, vjust = 1))
dev.off()

```

# Sensitivity analysis

```{r}
#Cases

cases <- read.csv("cases_by_county.csv")
glimpse(cases)
cases <- cases[order(as.Date(cases$date)),]
cases <- cases[cases$date >= "2021-01-04" &
                 cases$date <= "2022-05-22",]
cases_nc <- cases %>%  dplyr::filter(state == "NC")
glimpse(cases_nc)
cases_nc <- cases_nc %>% group_by(date) %>% summarise(mean_cases=
                                            mean(rolling_average_cases_per_100k_centered))

#Wastewater

wastewater <- read.csv("wastewater_by_county.csv")
glimpse(wastewater)
wastewater <- wastewater[order(as.Date(wastewater$sampling_week)),]
wastewater <- wastewater[wastewater$sampling_week >= "2021-01-04" &
                           wastewater$sampling_week <= "2022-05-22",]
wastewater_nc <- wastewater %>%  dplyr::filter(state == "NC")
glimpse(wastewater_nc)
wastewater_nc <- wastewater_nc %>% group_by(sampling_week) %>% 
  summarise(mean_wastewater = mean(effective_concentration_rolling_average))
wastewater_nc$sampling_week <- as.Date(wastewater_nc$sampling_week)
wastewater_nc <- pad(wastewater_nc,start_val=as.Date("2021-01-04"),
                     end_val=as.Date("2022-05-22"))
wastewater_nc <- wastewater_nc %>% 
  mutate(mean_wastewater = na_locf(mean_wastewater,))
colnames(wastewater_nc)[1] <-"date"

#merge dataset

nc_data <- cbind(cases_nc,wastewater_nc[,-1])
glimpse(nc_data)
nc_data$date <- as.Date(nc_data$date)

#Line plots

png(filename = "line_plot_sensitivity_analysis.png",units = "cm",res = 700,
    width = 20, height = 14)
case_plot <- nc_data %>% ggplot(aes(date,mean_cases)) + geom_line() +
  ylab("COVID-19 case counts per 100k") + theme_bw()
ww_plot <- nc_data %>% ggplot(aes(date,mean_wastewater)) + geom_line() +
  ylab("Viral gene copies per mL") + theme_bw()
grid.arrange(case_plot,
             ww_plot)
dev.off()

#Correlations

png(filename = "nc_cor.png",units = "cm",res = 700,
    width = 20, height = 8)
nc_data %>% ggplot(aes(mean_wastewater,mean_cases)) + geom_point() +
  theme_bw() + xlab("Viral gene copies per mL") + ylab("New Cases")
dev.off()

cor.test(nc_data$mean_cases,nc_data$mean_wastewater)

#arima

cases <- xts(nc_data$mean_cases, order.by = nc_data$date)
attr(cases, 'frequency') <- 7 
periodicity(cases)  
cases  <- as.ts(cases)
#plot(decompose(log(cases)))

cases_deseasonalise <- seasadj(decompose(log(cases)))

cases_deseasonalise_train <- cases_deseasonalise[-c(491:504)]
cases_deseasonalise_test <- cases_deseasonalise[c(491:504)]

lowest_rmse<-Inf
lowest_mae<-Inf
best_mod<-NULL
best_mod_mae<-NULL

for (p in seq(1:4)){
  for (q in seq(1:4)){
    arima_mod_1 <- Arima(cases_deseasonalise_train, order = c(p,1,q))
    forecast_fit <- forecast::forecast(arima_mod_1,h=14)
    rmse_mod_1 <- rmse(cases_deseasonalise_test,forecast_fit$mean)
    if (rmse_mod_1 < lowest_rmse){
      lowest_rmse <- rmse_mod_1 
      best_mod <- arima_mod_1
    }
  }
}

lowest_rmse
best_mod #arima(3,1,1)

for (p in seq(1:4)){
  for (q in seq(1:4)){
    arima_mod_1 <- Arima(cases_deseasonalise_train, order = c(p,1,q))
    forecast_fit <- forecast::forecast(arima_mod_1,h=14)
    mae_mod <- mae(cases_deseasonalise_test,forecast_fit$mean)
    if (mae_mod < lowest_mae){
      lowest_mae <- mae_mod
      best_mod_mae <- arima_mod_1
    }
  }
} 

best_mod_mae
lowest_mae #arima(3,1,1)

best_arima_mod <- Arima(cases_deseasonalise_train, order = c(3,1,1))
best_arima_mod_forecast <- forecast::forecast(best_arima_mod,h=14)
rmse(cases_deseasonalise_test,best_arima_mod_forecast$mean) 
mae(cases_deseasonalise_test,best_arima_mod_forecast$mean) 
checkresiduals(best_arima_mod)

png(filename = "sensitivity_nc_arima.png",res = 700, units = "cm",
    width = 20, height = 10)
arima_plot <- autoplot(best_arima_mod_forecast) + 
  autolayer(best_arima_mod_forecast, series = "Forecasted") +
  autolayer(ts(cases_deseasonalise_test,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + xlab("Time")+
  ggtitle(NULL) + theme(legend.position = "none") 
dev.off()

exp(cases_deseasonalise_test[1]) 
exp(best_arima_mod_forecast$mean[1]) 
exp(best_arima_mod_forecast$lower[1,]) 
exp(best_arima_mod_forecast$upper[1,]) 
exp(best_arima_mod_forecast$mean[1])-exp(cases_deseasonalise_test[1])

exp(cases_deseasonalise_test[7])
exp(best_arima_mod_forecast$mean[7])
exp(best_arima_mod_forecast$lower[7,])
exp(best_arima_mod_forecast$upper[7,])
exp(best_arima_mod_forecast$mean[7])-exp(cases_deseasonalise_test[7])

exp(cases_deseasonalise_test[14])
exp(best_arima_mod_forecast$mean[14])
exp(best_arima_mod_forecast$lower[14,])
exp(best_arima_mod_forecast$upper[14,])
exp(best_arima_mod_forecast$mean[14])-exp(cases_deseasonalise_test[14])


#SARIMA

cases_train <- log(cases)[-c(491:504)]
cases_test <- log(cases)[c(491:504)]

sarima_rmse <- Inf
sarima_best_mod <-NULL

for (p in seq(0,3)){
  for (d in seq(0,3)){
    for (q in seq(0,3)){
      for (P in seq(0,3)){
        for (D in seq(0,3)){
          for (Q in seq(0,3)){
            
            sarima_mod_1 <- Arima(cases_train, order = c(p,d,q),
                                  seasonal = list(order=c(P,D,Q),period=7),
                                  method="CSS")
            forecast_fit <- forecast::forecast(sarima_mod_1,14)
            rsme_mod <- rmse(cases_test,forecast_fit$mean)
            if(rsme_mod<sarima_rmse){
              sarima_rmse<- rsme_mod 
              sarima_best_mod<-sarima_mod_1 
            }
          }
        }
      }
    }
  }
}

sarima_rmse
sarima_best_mod #arima(0,3,3)(1,3,2)[7]

sarima_mae <- Inf
sarima_best_mod_mae <-NULL

for (p in seq(0,3)){
  for (d in seq(0,3)){
    for (q in seq(0,3)){
      for (P in seq(0,3)){
        for (D in seq(0,3)){
          for (Q in seq(0,3)){
            
            sarima_mod_1 <- Arima(cases_train, order = c(p,d,q),
                                  seasonal = list(order=c(P,D,Q),period=7),
                                  method="CSS")
            forecast_fit <- forecast::forecast(sarima_mod_1,14)
            mae_mod <- mae(cases_test,forecast_fit$mean)
            if(mae_mod<sarima_mae){
              sarima_mae<- mae_mod 
              sarima_best_mod_mae<-sarima_mod_1 
            }
          }
        }
      }
    }
  }
}

sarima_mae 
sarima_best_mod_mae 

sarima_best_mod_1 <- Arima(cases_train, order = c(0,3,3),
                           seasonal = list(order=c(1,3,2),period=7),
                           method="CSS")
sarima_best_mod_1_forecast <- forecast::forecast(sarima_best_mod_1,14)
rmse(cases_test,sarima_best_mod_1_forecast$mean)
mae(cases_test,sarima_best_mod_1_forecast$mean)
checkresiduals(sarima_best_mod_1)

sarima_best_mod_3 <- Arima(cases_train, order = c(0,3,2),
                           seasonal = list(order=c(3,2,2),period=7),
                           method="CSS")
coeftest(sarima_best_mod_3)
sarima_best_mod_3_forecast <- forecast::forecast(sarima_best_mod_3,14)
rmse(cases_test,sarima_best_mod_3_forecast$mean) 
mae(cases_test,sarima_best_mod_3_forecast$mean) 
checkresiduals(sarima_best_mod_3)

png(filename = "sensitivity_nc_sarima_simple.png",res = 700, units = "cm",
    width = 20, height = 10)
sarima_plot <- autoplot(sarima_best_mod_3_forecast) + 
  autolayer(sarima_best_mod_3_forecast, series = "Forecasted") +
  autolayer(ts(cases_deseasonalise_test,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + xlab("Time")+
  ggtitle(NULL) + theme(legend.position = "none") 
dev.off()

exp(cases_deseasonalise_test[1]) 
exp(sarima_best_mod_3_forecast$mean[1]) 
exp(sarima_best_mod_3_forecast$lower[1,])
exp(sarima_best_mod_3_forecast$upper[1,]) 
exp(sarima_best_mod_3_forecast$mean[1])-exp(cases_test[1])

exp(cases_deseasonalise_test[7])
exp(sarima_best_mod_3_forecast$mean[7])
exp(sarima_best_mod_3_forecast$lower[7,])
exp(sarima_best_mod_3_forecast$upper[7,])
exp(sarima_best_mod_3_forecast$mean[7])-exp(cases_test[7])

exp(cases_deseasonalise_test[14])
exp(sarima_best_mod_3_forecast$mean[14])
exp(sarima_best_mod_3_forecast$lower[14,])
exp(sarima_best_mod_3_forecast$upper[14,])
exp(sarima_best_mod_3_forecast$mean[14])-exp(cases_test[14])

#multivariate modelling#

#ARIMAX, with water

viral_deseasonalise <- seasadj(decompose(ts(log(nc_data$mean_wastewater),
                                            frequency = 7)))

viral_deseasonalise_train <- viral_deseasonalise[-c(491:504)]
viral_deseasonalise_test <- viral_deseasonalise[c(491:504)]

wastewater_mod <- Arima(cases_deseasonalise_train ,order = c(3,1,1),
                        xreg = viral_deseasonalise_train)
coeftest(wastewater_mod) 
forecast_mod_1 <- forecast::forecast(wastewater_mod, h=14,
                                     xreg = viral_deseasonalise_test) 
rmse(cases_deseasonalise_test,forecast_mod_1$mean) 
mae(cases_deseasonalise_test,forecast_mod_1$mean) 
tsdisplay(residuals(wastewater_mod)) 

png(filename = "sensitivity_nc_arimax.png",res = 700, units = "cm",
    width = 20, height = 10)
arimax_plot <- autoplot(forecast_mod_1) + 
  autolayer(forecast_mod_1 , series = "Forecasted") +
  autolayer(ts(cases_deseasonalise_test,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + xlab("Time") +
  ggtitle(NULL) + theme(legend.position = "none")
dev.off()

exp(cases_deseasonalise_test[1]) 
exp(forecast_mod_1$mean[1]) 
exp(forecast_mod_1$lower[1,]) 
exp(forecast_mod_1$upper[1,]) 
exp(forecast_mod_1$mean[1])-exp(cases_deseasonalise_test[1])

exp(cases_deseasonalise_test[7])
exp(forecast_mod_1$mean[7])
exp(forecast_mod_1$lower[7,])
exp(forecast_mod_1$upper[7,])
exp(forecast_mod_1$mean[7])-exp(cases_deseasonalise_test[7])

exp(cases_deseasonalise_test[14])
exp(forecast_mod_1$mean[14])
exp(forecast_mod_1$lower[14,])
exp(forecast_mod_1$upper[14,])
exp(forecast_mod_1$mean[14])-exp(cases_deseasonalise_test[14])

#SARIMAX, with water

viral_train <- log(nc_data$mean_wastewater)[-c(491:504)]
viral_test <- log(nc_data$mean_wastewater)[c(491:504)]

sarimax_wastewater_mod <- Arima(cases_train ,order = c(0,3,2),
                               seasonal = list(order=c(3,2,2),period=7),
                               xreg = viral_train,
                               method = "CSS-ML")
coeftest(sarimax_wastewater_mod) 
sarimax_wastewater_mod_forecast <- forecast::forecast(sarimax_wastewater_mod, h=14,
                                                     xreg = viral_test) 
rmse(cases_test,sarimax_wastewater_mod_forecast$mean) 
mae(cases_test,sarimax_wastewater_mod_forecast$mean) 
checkresiduals(sarimax_wastewater_mod) 

png(filename = "sensitivity_nc_sarimax_complex.png",res = 700, units = "cm",
    width = 20, height = 10)
sarimax_plot <- autoplot(sarimax_wastewater_mod_forecast) + 
  autolayer(sarimax_wastewater_mod_forecast, series = "Forecasted") +
  autolayer(ts(cases_test,start = 491), series = "Observed") +
  theme_bw(base_size = 15) + ylab("") + xlab("Time") +
  ggtitle(NULL) + theme(legend.position = "none") 
dev.off()

exp(sarimax_wastewater_mod_forecast$mean[1]) 
exp(sarimax_wastewater_mod_forecast$lower[1,]) 
exp(sarimax_wastewater_mod_forecast$upper[1,]) 
exp(sarimax_wastewater_mod_forecast$mean[1])-exp(cases_test[1])

exp(sarimax_wastewater_mod_forecast$mean[7])
exp(sarimax_wastewater_mod_forecast$lower[7,])
exp(sarimax_wastewater_mod_forecast$upper[7,])
exp(sarimax_wastewater_mod_forecast$mean[7])-exp(cases_test[7])

exp(sarimax_wastewater_mod_forecast$mean[14])
exp(sarimax_wastewater_mod_forecast$lower[14,])
exp(sarimax_wastewater_mod_forecast$upper[14,])
exp(sarimax_wastewater_mod_forecast$mean[14])-exp(cases_test[14])

#Autoregressive Distributed Lag Model

nc_data <- nc_data %>%
  mutate(log_cases = log(mean_cases),
         log_viral = log(mean_wastewater))

nc_data <- nc_data %>%
  mutate(log_cases = seasadj(decompose(ts(log_cases,frequency = 7))),
         log_viral = seasadj(decompose(ts(log_viral,frequency = 7))))

nc_data_train <- nc_data[-c(491:504),]
nc_data_test <- nc_data[c(491:504),]

lowest_rmse_ardl <- Inf
best_mod_ardl <- NULL

for (p in seq(1,14)){
  for (q in seq(1,14)){
    mod <- ardlDlm(log_cases ~ log_viral,
                   data = nc_data_train, p=p,q=q)
    f <- forecast(mod, x= t(nc_data_test[,5]),h=14)
    forecast_acc <- rmse(nc_data_test[,4],
                         f$forecasts)
    if (forecast_acc<lowest_rmse_ardl){
      lowest_rmse_ardl<- forecast_acc
      best_mod_ardl <- mod 
    }
  }
}

lowest_rmse_ardl #0.153
summary(best_mod_ardl) #ardl(1,14), similar to wake
checkresiduals(best_mod_ardl)

mod_ardl114 <- ardlDlm(log_cases ~ log_viral,
                       data = nc_data_train,p=14,q=1)
summary(mod_ardl114)
f_ardl114  <- forecast(mod_ardl114, 
                       x= t(nc_data_test[,5]),
                       h=14,
                       interval = TRUE)
rmse(nc_data_test$log_cases,
     f_ardl114$forecasts[,2])
mae(nc_data_test$log_cases,
     f_ardl114$forecasts[,2])
checkresiduals(mod_ardl114)

nc_data_test <- cbind(nc_data_test,f_ardl114$forecasts[,2],f_ardl114$forecasts[,1],
                      f_ardl114$forecasts[,3])

png(filename = "sensitivity_nc_ardl.png",res = 700, units = "cm",
    width = 20, height = 10)
ardl_plot <- nc_data_train %>% ggplot(aes(date,log_cases)) + 
  geom_line() + 
  geom_ribbon(data = nc_data_test , aes(ymin = f_ardl114$forecasts[,1], 
                                        ymax = f_ardl114$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) +
  geom_line(data = nc_data_test,aes(date,log_cases,color="Actual")) +
  geom_line(data = nc_data_test,aes(date,f_ardl114$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "bottom") + ylab("")
dev.off()

exp(f_ardl114 $forecasts[1,2])
exp(f_ardl114 $forecasts[1,1])
exp(f_ardl114 $forecasts[1,3])
exp(f_ardl114 $forecasts[1,2]) - exp(nc_data_test[1,4])

exp(f_ardl114 $forecasts[7,2])
exp(f_ardl114 $forecasts[7,1])
exp(f_ardl114 $forecasts[7,3])
exp(f_ardl114$forecasts[7,2]) - exp(nc_data_test[7,4])

exp(f_ardl114 $forecasts[14,2])
exp(f_ardl114$forecasts[14,1])
exp(f_ardl114$forecasts[14,3])
exp(f_ardl114 $forecasts[14,2]) - exp(nc_data_test[14,4])

#Distributed lag model

lowest_rmse_dl <- Inf
best_mod_dl <- NULL

for (q in seq(1,14)){
  mod <- dlm(log_cases ~ log_viral,
             data = nc_data_train,q=q)
  f <- forecast(mod, x= t(nc_data_test[,5]),h=14)
  forecast_acc <- mae(nc_data_test[,4],
                      f$forecasts)
  if (forecast_acc<lowest_rmse_dl){
    lowest_rmse_dl <- forecast_acc
    best_mod_dl <-mod 
  }
}


lowest_rmse_dl #0.622
summary(best_mod_dl) #DL(14)
checkresiduals(best_mod_dl)

mod_dl14 <- dlm(log_cases ~ log_viral,
               data = nc_data_train,q=14)
summary(mod_dl14)
f_dl14 <- forecast(mod_dl14, 
                       x= t(nc_data_test[,5]),
                       h=14,
                   interval = TRUE)
rmse(nc_data_test$log_cases,
     f_dl14$forecasts[,2])
mae(nc_data_test$log_cases,
    f_dl14$forecasts[,2])
checkresiduals(mod_dl14)

nc_data_test <- cbind(nc_data_test,f_dl14$forecasts[,2],
                      f_dl14$forecasts[,1],
                      f_dl14$forecasts[,3])

png(filename = "sensitivity_nc_dl.png",res = 700, units = "cm",
    width = 20, height = 10)
dl_plot <- nc_data_train %>% ggplot(aes(date,log_cases)) + 
  geom_line() + 
  geom_ribbon(data = nc_data_test , aes(ymin = f_dl14$forecasts[,1], 
                                        ymax = f_dl14$forecasts[,3]),
              fill = adjustcolor( "red", alpha.f = 0.2)) + 
  geom_line(data = nc_data_test,aes(date,log_cases,color="Actual")) +
  geom_line(data = nc_data_test,aes(date,f_dl14$forecasts[,2],color="Forecasted")) +
  scale_colour_manual(values=c("Actual"="cyan", "Forecasted"="red"), 
                      labels=c("Actual", "Forecasted")) +
  theme_bw() + theme(legend.position = "none") + ylab("")
dev.off()


exp(f_dl14 $forecasts[1,2])
exp(f_dl14  $forecasts[1,1])
exp(f_dl14 $forecasts[1,3])
exp(f_dl14  $forecasts[1,2]) - exp(nc_data_test[1,4])

exp(f_dl14  $forecasts[7,2])
exp(f_dl14  $forecasts[7,1])
exp(f_dl14  $forecasts[7,3])
exp(f_dl14 $forecasts[7,2]) - exp(nc_data_test[7,4])

exp(f_dl14  $forecasts[14,2])
exp(f_dl14 $forecasts[14,1])
exp(f_dl14 $forecasts[14,3])
exp(f_dl14  $forecasts[14,2]) - exp(nc_data_test[14,4])

#forecasting

png(filename = "sensitivity_plots.png", res = 700,
    units = "cm", width = 20, height = 27)
grid.arrange(arima_plot,
             sarima_plot,
             arimax_plot,
             sarimax_plot,
             dl_plot,
             ardl_plot,
             ncol=1,
             left = text_grob("Logarithm of New COVID-19 cases per 10K", rot = 90, vjust = 1))
dev.off()

```

